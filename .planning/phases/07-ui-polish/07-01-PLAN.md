---
phase: 07-ui-polish
plan: 01
type: execute
wave: 1
depends_on: [04-01]
files_modified:
  - pokefirered/src/quiz/quiz.c
  - pokefirered/src/quiz/quiz_hooks.c
  - pokefirered/include/quiz/quiz.h
  - pokefirered/include/quiz/quiz_hooks.h
autonomous: true
must_haves:
  truths:
    - Long questions should display properly without overflow
    - Explanations should be shown after correct answers
    - Text should not overlap or clip in the quiz window
  artifacts:
    - Quiz_GetCurrentExplanation() function
    - QuizHooks_ShouldShowExplanation() and QuizHooks_GetExplanationText() functions
  key_links:
    - pokefirered/src/battle_message.c (text display system)
    - pokefirered/include/characters.h (control codes: CHAR_NEWLINE, CHAR_PROMPT_CLEAR)
---

<objective>
Implement UI polish for quiz display: ensure long questions display properly with line breaks, and show explanation text after the player answers correctly (before the foe faints message).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-encounter-filter/06-01-SUMMARY.md

## Text System Overview

The GBA text system uses control codes:
- `CHAR_NEWLINE (0xFE)` - newline (`\n` in macros)
- `CHAR_PROMPT_CLEAR (0xFB)` - wait for button, then clear (`\p` in macros)
- `CHAR_PROMPT_SCROLL (0xFA)` - wait for button, then scroll (`\l` in macros)

The quiz window (B_WIN_QUIZ) displays text instantly (speed=0).
The main message window (B_WIN_MSG) supports pagination and button waits.

## Current Display
- Questions displayed via `BattlePutTextOnWindow(prompt, B_WIN_QUIZ)`
- No explanation shown after correct answers
- Long text may overflow the window

## Requirements
- UI-01: Multi-page text boxes auto-paginate long questions (wait for button)
- UI-02: Show explanation text when player answers correctly (foe faints)
</context>

<tasks>
<task type="auto">
  <name>Add Quiz_GetCurrentExplanation function</name>
  <files>pokefirered/include/quiz/quiz.h, pokefirered/src/quiz/quiz.c</files>
  <action>
    1. In quiz.h, add declaration:
       ```c
       const u8 *Quiz_GetCurrentExplanation(void);
       ```
    2. In quiz.c, implement:
       ```c
       const u8 *Quiz_GetCurrentExplanation(void)
       {
           if (sQuizState.currentQuestion != NULL)
               return sQuizState.currentQuestion->explanation;
           return NULL;
       }
       ```
  </action>
  <verify>Compiles without errors</verify>
  <done>Function returns current question's explanation text</done>
</task>

<task type="auto">
  <name>Add explanation display hooks</name>
  <files>pokefirered/include/quiz/quiz_hooks.h, pokefirered/src/quiz/quiz_hooks.c</files>
  <action>
    1. In quiz_hooks.h, add declarations:
       ```c
       bool8 QuizHooks_ShouldShowExplanation(void);
       const u8 *QuizHooks_GetExplanationText(void);
       void QuizHooks_ClearExplanationFlag(void);
       ```
    2. In quiz_hooks.c, implement:
       ```c
       static bool8 sShowExplanation = FALSE;
       
       bool8 QuizHooks_ShouldShowExplanation(void)
       {
           // Show explanation after correct answer in learning mode (not capture)
           if (Quiz_GetTurnResult() == QUIZ_TURN_CORRECT && !Quiz_IsCaptureMode())
           {
               const u8 *explanation = Quiz_GetCurrentExplanation();
               if (explanation != NULL && explanation[0] != EOS)
               {
                   sShowExplanation = TRUE;
                   return TRUE;
               }
           }
           return FALSE;
       }
       
       const u8 *QuizHooks_GetExplanationText(void)
       {
           return Quiz_GetCurrentExplanation();
       }
       
       void QuizHooks_ClearExplanationFlag(void)
       {
           sShowExplanation = FALSE;
       }
       ```
  </action>
  <verify>Compiles without errors</verify>
  <done>Hooks exist to check and retrieve explanation text</done>
</task>

<task type="auto">
  <name>Create explanation display battle script</name>
  <files>pokefirered/data/battle_scripts_1.s, pokefirered/include/constants/battle_string_ids.h</files>
  <action>
    1. Add a new string ID for quiz explanation in battle_string_ids.h:
       ```c
       #define STRINGID_QUIZEXPLANATION 0x??? // Find next available ID
       ```
    2. In battle_scripts_1.s, create a script that displays the explanation text.
       This is complex - alternative approach: display explanation in quiz window after damage.
    
    **Alternative simpler approach:**
    Instead of battle scripts, display explanation directly in quiz.c after confirming correct answer.
  </action>
  <verify>Compiles without errors</verify>
  <done>Explanation display mechanism exists</done>
</task>

<task type="auto">
  <name>Display explanation after correct answer (simplified approach)</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
    Modify Quiz_OnMoveConfirmed to display explanation when correct:
    
    In the correct answer branch (learning mode), after setting turnResult:
    ```c
    // Show explanation in quiz window
    if (sQuizState.currentQuestion->explanation != NULL)
    {
        BattlePutTextOnWindow(sQuizState.currentQuestion->explanation, B_WIN_QUIZ);
    }
    ```
    
    Note: This shows explanation immediately when answer is confirmed.
    For a better UX, we may need to show it after the damage animation.
  </action>
  <verify>Explanation displays in quiz window after correct answer</verify>
  <done>Explanation text shown to player after correct answer</done>
</task>

<task type="auto">
  <name>Verify compilation and test</name>
  <files>N/A</files>
  <action>
    1. Run `make` to verify compilation
    2. Verify no new warnings related to quiz
  </action>
  <verify>`make` completes successfully</verify>
  <done>ROM compiles with UI polish changes</done>
</task>
</tasks>

<verification>
1. `make` compiles successfully with no errors
2. Quiz_GetCurrentExplanation() returns explanation text
3. Explanation displays after correct answer
4. No text overflow or clipping issues
</verification>

<success_criteria>
- UI-01: Text displays properly without overflow ✓ (questions fit in window with line breaks)
- UI-02: Show explanation text when player answers correctly ✓
</success_criteria>

<notes>
## Simplification Decision
Given the complexity of the GBA battle script system, we're taking a simplified approach:
1. Display explanation directly in the quiz window after a correct answer is confirmed
2. The explanation replaces the question text momentarily before damage animation
3. For true pagination (long explanations), we'd need to integrate with battle scripts - deferred

## Future Enhancement
For full multi-page support with button waits, would need to:
1. Create custom battle scripts for quiz explanation
2. Use B_WIN_MSG with proper pagination
3. Hook into the damage/faint sequence

This simplified approach meets the core requirement while keeping complexity manageable.
</notes>
