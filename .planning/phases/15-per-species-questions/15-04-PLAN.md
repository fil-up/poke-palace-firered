---
phase: 15-per-species-questions
plan: 04
type: execute
wave: 3
depends_on: [15-02, 15-03]
files_modified:
  - pokefirered/src/quiz/quiz.c
  - pokefirered/tools/quiz/build_questions.py
autonomous: true

must_haves:
  truths:
    - "Questions selected from species bank, not topic pool"
    - "Quiz_InitWildEncounter uses Quiz_GetBank(species)"
    - "Topic pool structures removed or deprecated"
  artifacts:
    - path: "pokefirered/src/quiz/quiz.c"
      provides: "Species-based question selection"
      contains: "Quiz_GetBank call in Quiz_InitWildEncounter"
---

<objective>
Revert quiz logic to select questions from species bank instead of topic pool.

Purpose: Complete the transition to per-species questions by updating the core quiz initialization to use species banks rather than map-based topic pools.

Output:
- Quiz_InitWildEncounter uses Quiz_GetBank(species)
- Topic pool code removed/deprecated
- Clean build with species-based question selection
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@pokefirered/src/quiz/quiz.c
@pokefirered/include/quiz/questions_gen.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Quiz_InitWildEncounter</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Modify Quiz_InitWildEncounter to use species bank:

Remove topic pool selection:
```c
// REMOVE:
const struct QuizQuestion *question = Quiz_GetRandomQuestionForMap(sQuizState.currentMapId);
```

Restore species bank selection:
```c
// RESTORE:
const struct QuizBank *bank = Quiz_GetBank(species);
if (bank == NULL || bank->count == 0)
{
    // Handle missing bank - skip quiz or use fallback
    return FALSE;
}

// Select random question from species bank
u8 questionIndex = Random() % bank->count;
sQuizState.currentBank = bank;
sQuizState.currentQuestionIndex = questionIndex;
sQuizState.currentQuestion = &bank->questions[questionIndex];
```

Also remove:
- sQuizState.currentMapId tracking (if only used for topic pools)
- sQuizState.currentSection tracking
- Quiz_GetRandomQuestionForMap calls
  </action>
  <verify>Build compiles with species bank selection</verify>
  <done>Quiz_InitWildEncounter uses species bank for question selection</done>
</task>

<task type="auto">
  <name>Task 2: Update mastery tracking on correct answer</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Simplify Quiz_OnMoveConfirmed mastery update:

Remove section-aware updates:
```c
// REMOVE:
correctCount = Quiz_GetMasteryMaskInSection(species, sQuizState.currentSection);
Quiz_SetMasteryMaskInSection(species, sQuizState.currentSection, correctCount + 1);
```

Use global updates:
```c
// ADD:
u8 correctCount = Quiz_GetMasteryCount(sQuizState.currentSpecies);
if (correctCount < 255)
{
    correctCount++;
    Quiz_SetMasteryCount(sQuizState.currentSpecies, correctCount);
}

// Check for capture threshold
if (correctCount >= 5 && Quiz_GetSpeciesState(sQuizState.currentSpecies) != QUIZ_STATE_CAPTURE_PENDING)
{
    // State will be derived on next encounter
}
```
  </action>
  <verify>Correct answers increment global mastery count</verify>
  <done>Mastery tracking uses global species counter</done>
</task>

<task type="auto">
  <name>Task 3: Update progress display</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Simplify Quiz_GetMasteryProgress:

```c
void Quiz_GetMasteryProgress(u8 *mastered, u8 *total)
{
    u8 masteredCount = 0;
    
    if (!sQuizState.active)
    {
        if (mastered != NULL) *mastered = 0;
        if (total != NULL) *total = 5;
        return;
    }
    
    // Get global mastery count
    masteredCount = Quiz_GetMasteryCount(sQuizState.currentSpecies);
    
    // Cap at 5 for display
    if (masteredCount > 5)
        masteredCount = 5;
    
    if (mastered != NULL) *mastered = masteredCount;
    if (total != NULL) *total = 5;
}
```
  </action>
  <verify>Progress displays correctly (X/5)</verify>
  <done>Progress display uses global mastery count</done>
</task>

<task type="auto">
  <name>Task 4: Remove topic pool code from build tools</name>
  <files>pokefirered/tools/quiz/build_questions.py</files>
  <action>
Update build_questions.py to remove topic pool generation:

1. Remove --topics argument handling
2. Remove topic pool struct generation
3. Remove QuizMapConfig and QuizGymConfig generation
4. Keep species bank generation

Or alternatively, add a --mode=species flag to switch between:
- --mode=species: Generate species banks only
- --mode=topics: Generate topic pools (deprecated)

The script should:
- Read species_map.json
- Generate QuizBank structs per species
- Generate Quiz_GetBank(species) lookup function
  </action>
  <verify>Script generates species banks: `python3 tools/quiz/build_questions.py --help`</verify>
  <done>Build script updated to generate species banks without topic pools</done>
</task>

<task type="auto">
  <name>Task 5: Clean up deprecated code</name>
  <files>
    pokefirered/src/quiz/quiz.c
    pokefirered/include/quiz/questions_gen.h
  </files>
  <action>
Remove or deprecate unused code:

1. Remove Quiz_GetRandomQuestionForMap function
2. Remove Quiz_GetMapConfig, Quiz_GetGymConfig if unused
3. Remove topic pool struct definitions from questions_gen.h
4. Remove section_config includes where not needed

Keep gym battle logic working - may need to update to use species banks or a different approach.
  </action>
  <verify>Build clean with no unused function warnings</verify>
  <done>Deprecated topic pool code removed</done>
</task>

</tasks>

<verification>
1. Quiz_InitWildEncounter uses Quiz_GetBank(species)
2. Mastery tracking uses global counter
3. Progress display works correctly
4. Topic pool code removed from build tools
5. Build succeeds: `cd pokefirered && make -j4`
6. In-game test: Encounter Rattata, answer question, mastery increments
</verification>

<success_criteria>
- Questions selected from species bank in wild encounters
- Global mastery tracking works
- Progress shows X/5 correctly
- Topic pool code removed or deprecated
- Build compiles without errors
- In-game quiz flow works with per-species questions
</success_criteria>

<output>
After completion, create `.planning/phases/15-per-species-questions/15-04-SUMMARY.md`
</output>
