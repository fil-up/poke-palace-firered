---
phase: 15-per-species-questions
plan: 03
type: execute
wave: 3
depends_on: [15-02]
files_modified:
  - pokefirered/include/global.h
  - pokefirered/include/quiz/quiz.h
  - pokefirered/src/quiz/quiz.c
autonomous: true

must_haves:
  truths:
    - "Save data uses global species mastery (not section-based)"
    - "QuizSaveData fits within existing SaveBlock1 allocation"
    - "Mastery tracking uses per-species counter (0-255)"
  artifacts:
    - path: "pokefirered/include/global.h"
      provides: "Simplified QuizSaveData structure"
      contains: "masteryCount[151]"
    - path: "pokefirered/src/quiz/quiz.c"
      provides: "Global mastery accessor functions"
      contains: "Quiz_GetMasteryCount, Quiz_SetMasteryCount"
---

<objective>
Simplify save system by removing section-aware tracking, returning to global species mastery.

Purpose: Since each species now appears in only one location, section-based tracking is unnecessary. A species is either mastered/cleared globally or not.

Output:
- Simplified QuizSaveData in global.h
- Removed section-aware accessor functions
- Global mastery accessor functions
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@pokefirered/include/global.h
@pokefirered/include/quiz/quiz.h
@pokefirered/src/quiz/quiz.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify QuizSaveData in global.h</name>
  <files>pokefirered/include/global.h</files>
  <action>
Replace QuizSaveDataV2 with simplified structure:

Remove:
```c
struct QuizSaveDataV2
{
    u8 sectionCleared[8][20];   // Remove section arrays
    u8 masteryMask[8][28];      // Remove section arrays
};
```

Replace with:
```c
struct QuizSaveData
{
    u8 speciesCleared[20];      // 160 species as bits (20 * 8 = 160)
    u8 masteryCount[152];       // Mastery counter per species (0-255 correct answers)
};
// Total size: 20 + 152 = 172 bytes (fits in unused_348C which has 512 bytes)
```

Update STATIC_ASSERT for size check.
Keep the quizData pointer in SaveBlock1.
  </action>
  <verify>Build compiles: `cd pokefirered && make -j4 2>&1 | grep -i error`</verify>
  <done>QuizSaveData simplified to global species tracking</done>
</task>

<task type="auto">
  <name>Task 2: Update quiz.h declarations</name>
  <files>pokefirered/include/quiz/quiz.h</files>
  <action>
Update function declarations:

Remove section-aware functions:
```c
// REMOVE these:
u8 Quiz_GetMasteryMaskInSection(u16 species, u8 section);
void Quiz_SetMasteryMaskInSection(u16 species, u8 section, u8 mask);
bool8 Quiz_IsSpeciesClearedInSection(u16 species, u8 section);
void Quiz_SetSpeciesClearedInSection(u16 species, u8 section, bool8 cleared);
u8 Quiz_GetSpeciesStateInSection(u16 species, u8 section);
void Quiz_SetSpeciesStateInSection(u16 species, u8 section, u8 state);
```

Keep/Add global functions:
```c
// Keep these (global versions):
u8 Quiz_GetMasteryCount(u16 species);
void Quiz_SetMasteryCount(u16 species, u8 count);
bool8 Quiz_IsSpeciesCleared(u16 species);
void Quiz_SetSpeciesCleared(u16 species, bool8 cleared);
u8 Quiz_GetSpeciesState(u16 species);
void Quiz_SetSpeciesState(u16 species, u8 state);
```
  </action>
  <verify>Header compiles: check for declaration errors</verify>
  <done>quiz.h updated with global-only accessor declarations</done>
</task>

<task type="auto">
  <name>Task 3: Implement simplified accessors in quiz.c</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Update accessor implementations:

1. Remove all section-aware function implementations
2. Simplify global accessors to use new structure:

```c
u8 Quiz_GetMasteryCount(u16 species)
{
    if (species >= NUM_SPECIES)
        return 0;
    return gSaveBlock1Ptr->quizData.masteryCount[species];
}

void Quiz_SetMasteryCount(u16 species, u8 count)
{
    if (species >= NUM_SPECIES)
        return;
    gSaveBlock1Ptr->quizData.masteryCount[species] = count;
}

bool8 Quiz_IsSpeciesCleared(u16 species)
{
    u16 byteIndex, bitIndex;
    if (species >= NUM_SPECIES)
        return FALSE;
    byteIndex = species / 8;
    bitIndex = species % 8;
    return (gSaveBlock1Ptr->quizData.speciesCleared[byteIndex] >> bitIndex) & 1;
}

void Quiz_SetSpeciesCleared(u16 species, bool8 cleared)
{
    u16 byteIndex, bitIndex;
    if (species >= NUM_SPECIES)
        return;
    byteIndex = species / 8;
    bitIndex = species % 8;
    if (cleared)
        gSaveBlock1Ptr->quizData.speciesCleared[byteIndex] |= (1 << bitIndex);
    else
        gSaveBlock1Ptr->quizData.speciesCleared[byteIndex] &= ~(1 << bitIndex);
}

u8 Quiz_GetSpeciesState(u16 species)
{
    u8 count;
    
    if (Quiz_IsSpeciesCleared(species))
        return QUIZ_STATE_CLEARED;
    
    count = Quiz_GetMasteryCount(species);
    if (count >= 5)
        return QUIZ_STATE_CAPTURE_PENDING;
    if (count > 0)
        return QUIZ_STATE_MASTERING;
    
    return QUIZ_STATE_NONE;
}
```

3. Update Quiz_InitSaveData to initialize simplified structure
4. Remove Quiz_GetCurrentSection dependencies (or keep for other uses)
  </action>
  <verify>Build compiles and no section-aware function references remain</verify>
  <done>quiz.c updated with simplified global accessors</done>
</task>

<task type="auto">
  <name>Task 4: Update remaining references</name>
  <files>pokefirered/src/quiz/*.c</files>
  <action>
Search and update any remaining section-aware references:

1. In route_completion.c: Update to use Quiz_IsSpeciesCleared() without section
2. In wild_encounter.c: Update any section references
3. Remove includes of section_config.h where no longer needed

Also deprecate/remove section_config files:
- pokefirered/include/quiz/section_config.h (can delete or leave empty)
- pokefirered/src/quiz/section_config.c (can delete or leave empty)
  </action>
  <verify>Build compiles with no undefined references</verify>
  <done>All section-aware references updated to global</done>
</task>

</tasks>

<verification>
1. QuizSaveData simplified in global.h
2. Section-aware functions removed from quiz.h
3. Global accessors implemented in quiz.c
4. No section-aware function calls remain
5. Build succeeds: `cd pokefirered && make -j4`
</verification>

<success_criteria>
- QuizSaveData uses global species tracking only
- All mastery/cleared checks work without section parameter
- Species state derived from global mastery count
- Build compiles without errors
- Save data size fits within allocated space
</success_criteria>

<output>
After completion, create `.planning/phases/15-per-species-questions/15-03-SUMMARY.md`
</output>
