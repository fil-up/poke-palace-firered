---
phase: 14-map-questions-to-encounters
plan: 04
type: execute
wave: 3
depends_on: ["14-02", "14-03"]
files_modified:
  - pokefirered/src/quiz/quiz.c
  - pokefirered/src/quiz/quiz_hooks.c
autonomous: true

must_haves:
  truths:
    - "Wild encounters select questions from current map's topic pool, not species bank"
    - "Mastery tracking uses section-aware functions"
    - "Gym battles use gym-specific mastery pools from map_topics.json"
    - "Capture quiz still requires answering all questions for species mastery"
  artifacts:
    - path: "pokefirered/src/quiz/quiz.c"
      provides: "Section-aware quiz logic using topic pools"
      contains: "Quiz_GetRandomQuestionForMap"
    - path: "pokefirered/src/quiz/quiz_hooks.c"
      provides: "Updated battle hooks using section context"
      contains: "Quiz_GetCurrentSection"
  key_links:
    - from: "pokefirered/src/quiz/quiz.c"
      to: "pokefirered/src/quiz/topic_pools.c"
      via: "Quiz_GetRandomQuestionForMap"
      pattern: "Quiz_GetRandomQuestionForMap"
    - from: "pokefirered/src/quiz/quiz.c"
      to: "pokefirered/include/quiz/section_config.h"
      via: "Quiz_GetCurrentSection"
      pattern: "Quiz_GetCurrentSection"
---

<objective>
Convert quiz logic from species-based to topic-based question selection while maintaining capture mechanics.

Purpose: Questions are now selected from the current map's topic pool rather than from the species' bank. This enables section-based learning progression while keeping the capture mechanic (5 correct answers per species).

Output:
- Updated Quiz_InitWildEncounter to use topic pools
- Section-aware mastery tracking in quiz.c
- Updated gym battle logic for gym mastery pools
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-map-questions-to-encounters/14-CONTEXT.md
@.planning/phases/14-map-questions-to-encounters/14-02-SUMMARY.md
@.planning/phases/14-map-questions-to-encounters/14-03-SUMMARY.md
@pokefirered/src/quiz/quiz.c
@pokefirered/include/quiz/quiz.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Quiz_InitWildEncounter for topic-based selection</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Modify Quiz_InitWildEncounter() to select questions from topic pools:

1. Add includes at top of quiz.c:
```c
#include "quiz/topic_pools.h"
#include "quiz/section_config.h"
```

2. Add new state fields to sQuizState struct for topic-based tracking:
```c
struct QuizState {
    // ... existing fields ...
    u16 currentMapId;      // Map where encounter started
    u8 currentSection;     // Section for this encounter
    // ... rest of fields ...
};
```

3. Modify Quiz_InitWildEncounter() logic:

For WILD ENCOUNTERS (non-trainer):
```c
void Quiz_InitWildEncounter(u16 species, u8 mapGroup, u8 mapNum)
{
    const struct QuizQuestion *question;
    u8 state;
    u16 mapId;
    
    // Skip if already initialized this battle
    if (sQuizState.battleInitialized && sQuizState.currentSpecies == species)
        return;
    
    // Get current map ID and section
    mapId = (mapGroup << 8) | mapNum;
    if (mapId == 0)
        mapId = gMapHeader.mapLayoutId;  // Fallback to layout ID
    
    sQuizState.currentMapId = mapId;
    sQuizState.currentSection = Quiz_GetSectionForMap(mapId);
    
    // Check if this is a trainer battle
    if (gBattleTypeFlags & BATTLE_TYPE_TRAINER)
    {
        // Trainer battle logic (unchanged - uses existing Quiz_GetBank or area pool)
        // ... keep existing trainer battle initialization ...
        return;
    }
    
    // Wild encounter - use topic pool for question selection
    sQuizState.currentSpecies = species;
    sQuizState.isCapturing = FALSE;
    
    // Check species state IN CURRENT SECTION
    state = Quiz_GetSpeciesStateInSection(species, sQuizState.currentSection);
    
    if (state == QUIZ_STATE_CLEARED)
    {
        // Species already cleared in this section - shouldn't happen
        // (encounter filter should prevent this)
        sQuizState.isActive = FALSE;
        return;
    }
    
    if (state == QUIZ_STATE_CAPTURE_PENDING)
    {
        // All questions mastered - enter capture mode
        sQuizState.isCapturing = TRUE;
        sQuizState.captureQuestionIndex = 0;
        sQuizState.captureQuestionsTotal = 5;  // Fixed 5 for capture
    }
    
    // Select question from map's topic pool
    question = Quiz_GetRandomQuestionForMap(mapId);
    
    if (question == NULL)
    {
        // Fallback to species bank if no topic pool
        const struct QuizBank *bank = Quiz_GetBank(species);
        if (bank != NULL && bank->count > 0)
            question = bank->questions[Random() % bank->count];
    }
    
    if (question == NULL)
    {
        sQuizState.isActive = FALSE;
        return;
    }
    
    sQuizState.currentQuestion = question;
    sQuizState.isActive = TRUE;
    sQuizState.battleInitialized = TRUE;
    
    Quiz_UpdateDisplayText();
}
```

4. Keep the capture quiz logic but update mastery tracking:
When checking mastery for capture mode, use section-aware functions:
```c
// In the answer grading section, update mastery in current section
u8 currentMask = Quiz_GetMasteryMaskInSection(species, sQuizState.currentSection);
// ... mastery update logic ...
Quiz_SetMasteryMaskInSection(species, sQuizState.currentSection, newMask);
```

5. For checking if species is ready for capture:
```c
// Check if 5 questions mastered (capture ready)
u8 mastered = Quiz_CountMasteredQuestionsInSection(species, sQuizState.currentSection);
if (mastered >= 5)
{
    Quiz_SetSpeciesStateInSection(species, sQuizState.currentSection, QUIZ_STATE_CAPTURE_PENDING);
}
```

Note: You may need to add Quiz_CountMasteredQuestionsInSection() helper or adapt existing counting logic.
  </action>
  <verify>Build compiles: `cd pokefirered && make -j4 2>&1 | grep -E "error:" | head -5`</verify>
  <done>Quiz_InitWildEncounter uses topic pools for question selection, section-aware mastery tracking</done>
</task>

<task type="auto">
  <name>Task 2: Update mastery counting for section awareness</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Update mastery counting functions to work with section-aware save data:

1. Add helper to count mastered questions from mask:
```c
static u8 Quiz_CountBitsSet(u8 mask)
{
    u8 count = 0;
    while (mask)
    {
        count += mask & 1;
        mask >>= 1;
    }
    return count;
}
```

2. Update or add Quiz_CountMasteredQuestions to be section-aware:
```c
u8 Quiz_CountMasteredQuestionsForSpecies(u16 species)
{
    u8 section = Quiz_GetCurrentSection();
    u8 mask = Quiz_GetMasteryMaskInSection(species, section);
    return Quiz_CountBitsSet(mask);
}
```

3. Update the "all questions mastered" check in Quiz_OnMoveConfirmed:

Find the existing mastery check code and update it:
```c
// After marking a question as mastered:
u8 masteredCount = Quiz_CountMasteredQuestionsForSpecies(sQuizState.currentSpecies);
if (masteredCount >= 5)  // 5 questions = capture ready
{
    Quiz_SetSpeciesStateInSection(sQuizState.currentSpecies, 
                                   sQuizState.currentSection, 
                                   QUIZ_STATE_CAPTURE_PENDING);
}
```

4. Update Quiz_GetProgress() and Quiz_GetMasteryProgress() for UI display:
```c
void Quiz_GetMasteryProgress(u8 *mastered, u8 *total)
{
    *total = 5;  // Always 5 questions to master
    *mastered = Quiz_CountMasteredQuestionsForSpecies(sQuizState.currentSpecies);
}
```

5. Update capture success to mark cleared in section:
```c
// In capture success code path:
Quiz_SetSpeciesClearedInSection(sQuizState.currentSpecies, 
                                 sQuizState.currentSection, 
                                 TRUE);
```
  </action>
  <verify>Build compiles: `cd pokefirered && make -j4 2>&1 | tail -10`</verify>
  <done>Mastery counting uses section-aware functions, capture success marks cleared in current section</done>
</task>

<task type="auto">
  <name>Task 3: Update gym battle logic for gym mastery pools</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Update trainer/gym battle question selection to use gym mastery pools:

1. Check if the current map is a gym and use its mastery pool.

First, need to either:
A) Generate gym config data in topic_pools.c (from gyms_by_map in map_topics.json)
B) Or keep using Quiz_BuildAreaPool() for gym leaders but update it

Recommended: Update Quiz_BuildAreaPool() to use section topics instead of species banks.

2. Update Quiz_BuildAreaPool() to build from topic pools:
```c
static u8 Quiz_BuildAreaPool(void)
{
    // Instead of hardcoded species banks, use all topic pools
    // from maps in the current section
    
    const struct QuizMapConfig *config;
    const struct QuizTopicPool *pool;
    u16 mapId = sQuizState.currentMapId;
    u8 section = sQuizState.currentSection;
    u8 count = 0;
    u8 i, j;
    
    config = Quiz_GetMapConfig(mapId);
    if (config == NULL)
        return 0;
    
    // Add questions from all topic pools for this map
    for (i = 0; i < config->topicCount && count < MAX_POOL_SIZE; i++)
    {
        pool = config->topicPools[i];
        if (pool == NULL)
            continue;
        
        for (j = 0; j < pool->count && count < MAX_POOL_SIZE; j++)
        {
            sAreaPool[count++] = pool->questions[j];
        }
    }
    
    sAreaPoolCount = count;
    return count;
}
```

3. For gym leaders, you may want a special function to get the gym's mastery pool:
```c
static u8 Quiz_BuildGymMasteryPool(u16 gymMapId)
{
    // This would use gyms_by_map configuration
    // For now, can use the gym map's topic pools
    return Quiz_BuildAreaPool();
}
```

4. The existing trainer tier system (GYM_TRAINER, GYM_LEADER) should continue to work - they just need to pull questions from topic pools instead of species banks.

5. Update the trainer battle initialization section in Quiz_InitWildEncounter:
```c
if (gBattleTypeFlags & BATTLE_TYPE_TRAINER)
{
    // Get trainer tier
    u8 tier = Quiz_GetTrainerTier();
    
    // For gym leaders/trainers, build pool from map topics
    if (tier >= QUIZ_TRAINER_GYM_TRAINER)
    {
        Quiz_BuildAreaPool();  // Uses topic pools now
        // Select from pool
        if (sAreaPoolCount > 0)
        {
            question = sAreaPool[Random() % sAreaPoolCount];
        }
    }
    else
    {
        // Regular trainer - use map's topic pool
        question = Quiz_GetRandomQuestionForMap(sQuizState.currentMapId);
    }
    
    // ... rest of trainer battle setup ...
}
```
  </action>
  <verify>Build and run test: `cd pokefirered && make -j4` succeeds, can test gym battles in-game</verify>
  <done>Gym battles use topic pools for question selection, gym leaders use aggregated area topic pools</done>
</task>

</tasks>

<verification>
1. Wild encounter questions come from current map's topic pool
2. Mastery is tracked per-section (same species in different section has fresh mastery)
3. Capture still requires 5 correct answers
4. Cleared status is section-specific
5. Gym battles use gym map's topic pools
6. `cd pokefirered && make -j4` builds without errors
</verification>

<success_criteria>
- Quiz_InitWildEncounter calls Quiz_GetRandomQuestionForMap(mapId)
- Mastery functions use Quiz_Get/SetMasteryMaskInSection
- Species cleared status uses Quiz_IsSpeciesClearedInSection
- Trainer battles use Quiz_BuildAreaPool with topic pool data
- All existing quiz functionality continues to work
- Build compiles and links
</success_criteria>

<output>
After completion, create `.planning/phases/14-map-questions-to-encounters/14-04-SUMMARY.md`
</output>
