---
phase: 14-map-questions-to-encounters
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - pokefirered/tools/quiz/build_questions.py
  - pokefirered/src/quiz/quiz.c
  - pokefirered/include/quiz/quiz_hooks.h
autonomous: true

must_haves:
  truths:
    - "sAllQuizBanks array is auto-generated, not manually maintained"
    - "Quiz_BuildFullPool() iterates over all 130 species banks"
    - "QUIZ_POOL_MAX_QUESTIONS is sufficient for largest gym pool"
  artifacts:
    - path: "pokefirered/tools/quiz/build_questions.py"
      provides: "Auto-generation of sAllQuizBanks array"
      contains: "sAllQuizBanks"
    - path: "pokefirered/src/quiz/quiz.c"
      provides: "Runtime pool building with generated array"
      contains: "sAllQuizBanks"
    - path: "pokefirered/include/quiz/quiz_hooks.h"
      provides: "Increased pool size constant"
      contains: "QUIZ_POOL_MAX_QUESTIONS"
  key_links:
    - from: "pokefirered/tools/quiz/build_questions.py"
      to: "pokefirered/src/quiz/quiz.c"
      via: "Generated sAllQuizBanks extern or inline"
      pattern: "sAllQuizBanks"
    - from: "pokefirered/include/quiz/quiz_hooks.h"
      to: "pokefirered/src/quiz/quiz.c"
      via: "#include"
      pattern: "QUIZ_POOL_MAX_QUESTIONS"
---

<objective>
Auto-generate sAllQuizBanks array and increase pool size limit to support full species coverage.

Purpose: Currently sAllQuizBanks is manually maintained with 12 entries. With 130 species, manual maintenance is error-prone. This plan modifies the build pipeline to auto-generate the array and increases QUIZ_POOL_MAX_QUESTIONS for larger gym pools.

Output: build_questions.py generates sAllQuizBanks, quiz.c uses the generated array, pool limit increased to 300+.
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-map-questions-to-encounters/14-RESEARCH.md
@.planning/phases/14-map-questions-to-encounters/14-01-SUMMARY.md

@pokefirered/src/quiz/quiz.c
@pokefirered/tools/quiz/build_questions.py
@pokefirered/include/quiz/quiz_hooks.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify build_questions.py to generate sAllQuizBanks array</name>
  <files>pokefirered/tools/quiz/build_questions.py</files>
  <action>
Modify `generate_source()` in build_questions.py to also output the sAllQuizBanks array definition.

After the species bank definitions, add:

```c
// All quiz banks array (auto-generated)
const struct QuizBank *const gAllQuizBanks[] =
{
    &gQuizBank_SPECIES_ABRA,
    &gQuizBank_SPECIES_BELLSPROUT,
    // ... all species in alphabetical order ...
};

const u8 gAllQuizBanksCount = ARRAY_COUNT(gAllQuizBanks);
```

Also add to `generate_header()`:

```c
// All quiz banks array
extern const struct QuizBank *const gAllQuizBanks[];
extern const u8 gAllQuizBanksCount;
```

Implementation:
1. In generate_source(), after the species banks loop, add:
   ```python
   # Generate all banks array
   lines.append('// All quiz banks array (auto-generated)')
   lines.append('const struct QuizBank *const gAllQuizBanks[] =')
   lines.append('{')
   for species in sorted(species_map.keys()):
       lines.append(f'    &gQuizBank_{species},')
   lines.append('};')
   lines.append('')
   lines.append(f'const u8 gAllQuizBanksCount = {len(species_map)};')
   lines.append('')
   ```

2. In generate_header(), add extern declarations before the endif:
   ```python
   lines.extend([
       '// All quiz banks array',
       'extern const struct QuizBank *const gAllQuizBanks[];',
       'extern const u8 gAllQuizBanksCount;',
       '',
   ])
   ```

3. Regenerate C files after modification:
   ```bash
   cd pokefirered/data/questions
   python ../../tools/quiz/build_questions.py questions.csv \
     --mapping species_map.json \
     --out-dir ../../
   ```
  </action>
  <verify>
- `grep "gAllQuizBanks\[\]" pokefirered/src/quiz/questions_gen.c` shows the array definition
- `grep "gAllQuizBanksCount" pokefirered/include/quiz/questions_gen.h` shows extern declaration
- Array contains ~130 entries (one per species)
  </verify>
  <done>
build_questions.py generates gAllQuizBanks[] array with all species banks, questions_gen.c/.h updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update quiz.c to use generated array and increase pool limit</name>
  <files>
pokefirered/src/quiz/quiz.c
pokefirered/include/quiz/quiz_hooks.h
  </files>
  <action>
1. **Increase QUIZ_POOL_MAX_QUESTIONS** in quiz_hooks.h (or quiz.c if defined there):
   
   Find and update:
   ```c
   // Old: #define QUIZ_POOL_MAX_QUESTIONS 100
   #define QUIZ_POOL_MAX_QUESTIONS 350
   ```
   
   Rationale: 130 species × 5 questions = 650 total, but gym pools only need prior areas.
   Late-game gyms might have 50+ species × 5 = 250+ questions. 350 provides margin.

2. **Remove manual sAllQuizBanks array** from quiz.c (lines ~116-130):
   
   Delete the static array:
   ```c
   // DELETE THIS:
   static const struct QuizBank *const sAllQuizBanks[] =
   {
       &gQuizBank_SPECIES_BULBASAUR,
       ...
   };
   ```

3. **Update Quiz_BuildFullPool()** to use generated array:
   
   Change from:
   ```c
   static u8 Quiz_BuildFullPool(void)
   {
       u8 count = 0;
       u8 i;
       
       for (i = 0; i < ARRAY_COUNT(sAllQuizBanks); i++)
           count = Quiz_AddBankToPool(sAllQuizBanks[i], count);
       
       return count;
   }
   ```
   
   To:
   ```c
   static u8 Quiz_BuildFullPool(void)
   {
       u8 count = 0;
       u8 i;
       
       for (i = 0; i < gAllQuizBanksCount; i++)
           count = Quiz_AddBankToPool(gAllQuizBanks[i], count);
       
       return count;
   }
   ```

4. **Verify include** at top of quiz.c:
   ```c
   #include "quiz/questions_gen.h"
   ```

5. Build and verify:
   ```bash
   cd pokefirered && make -j4
   ```
  </action>
  <verify>
- `grep -c "static const struct QuizBank \*const sAllQuizBanks" pokefirered/src/quiz/quiz.c` returns 0 (removed)
- `grep "gAllQuizBanks\[" pokefirered/src/quiz/quiz.c` shows usage in Quiz_BuildFullPool
- `grep "QUIZ_POOL_MAX_QUESTIONS" pokefirered/include/quiz/quiz_hooks.h` shows 350 (or appropriate size)
- `make` succeeds
  </verify>
  <done>
quiz.c uses auto-generated gAllQuizBanks array, QUIZ_POOL_MAX_QUESTIONS increased, project compiles.
  </done>
</task>

</tasks>

<verification>
1. build_questions.py generates gAllQuizBanks[] array with 130 entries
2. questions_gen.h has extern declarations for gAllQuizBanks and gAllQuizBanksCount
3. quiz.c no longer has manual sAllQuizBanks array
4. Quiz_BuildFullPool() uses gAllQuizBanks and gAllQuizBanksCount
5. QUIZ_POOL_MAX_QUESTIONS >= 300
6. Project builds without errors
</verification>

<success_criteria>
- [ ] build_questions.py modified to output gAllQuizBanks array
- [ ] questions_gen.c contains auto-generated array with ~130 banks
- [ ] Manual sAllQuizBanks removed from quiz.c
- [ ] Quiz_BuildFullPool() uses generated array
- [ ] QUIZ_POOL_MAX_QUESTIONS increased to 350
- [ ] `make` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/14-map-questions-to-encounters/14-02-SUMMARY.md`
</output>
