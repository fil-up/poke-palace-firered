---
phase: 14-map-questions-to-encounters
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - pokefirered/tools/quiz/build_questions.py
  - pokefirered/include/quiz/topic_pools.h
  - pokefirered/src/quiz/topic_pools.c
  - pokefirered/include/quiz/questions_gen.h
  - pokefirered/src/quiz/questions_gen.c
autonomous: true

must_haves:
  truths:
    - "Questions are grouped by Broad_Category + Sub_Topic into topic pools"
    - "Quiz_GetTopicPool(category, topic) returns pool with question pointers and count"
    - "Quiz_GetMapConfig(mapId) returns topic pool references for the map"
    - "Quiz_GetGymConfig(gymId) returns mastery pool references for gym battles"
    - "Topic pools are const ROM data (no dynamic allocation)"
  artifacts:
    - path: "pokefirered/include/quiz/topic_pools.h"
      provides: "Topic pool structures and lookup declarations"
      contains: "struct QuizTopicPool"
    - path: "pokefirered/src/quiz/topic_pools.c"
      provides: "Generated topic-indexed question pools"
      contains: "gQuizTopicPool_"
    - path: "pokefirered/tools/quiz/build_questions.py"
      provides: "Updated build script generating topic pools"
      contains: "generate_topic_pools"
  key_links:
    - from: "pokefirered/src/quiz/topic_pools.c"
      to: "pokefirered/src/quiz/questions_gen.c"
      via: "Question struct references"
      pattern: "sQuestion_"
    - from: "pokefirered/tools/quiz/build_questions.py"
      to: "pokefirered/data/questions/map_topics.json"
      via: "JSON config loading"
      pattern: "map_topics.json"
---

<objective>
Modify build tools to generate topic-indexed question pools instead of only species-indexed banks.

Purpose: Enable question selection by map topic rather than species. The build script will read map_topics.json and generate topic pools that quiz.c can use at runtime.

Output:
- Updated build_questions.py that generates topic pools
- topic_pools.h with pool structures and declarations
- topic_pools.c with generated topic pool data
- Updated questions_gen.h/c with topic pool support
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-map-questions-to-encounters/14-CONTEXT.md
@.planning/phases/14-map-questions-to-encounters/14-RESEARCH.md
@.planning/phases/14-map-questions-to-encounters/14-01-SUMMARY.md
@pokefirered/tools/quiz/build_questions.py
@pokefirered/data/questions/map_topics.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update build_questions.py to generate topic pools</name>
  <files>pokefirered/tools/quiz/build_questions.py</files>
  <action>
Modify build_questions.py to add topic pool generation:

1. Add new argument parser option:
```python
parser.add_argument(
    '--topics',
    type=Path,
    help='Path to map_topics.json (generates topic pools)'
)
```

2. Add function to load topic config:
```python
def load_topic_config(topics_path: Path | None) -> dict:
    """Load map_topics.json configuration."""
    if topics_path is None or not topics_path.exists():
        return {}
    
    with open(topics_path, 'r', encoding='utf-8') as f:
        return json.load(f)
```

3. Add function to group questions by category+topic:
```python
def group_by_topic(questions: dict[str, Question]) -> dict[tuple[str, str], list[str]]:
    """Group question IDs by (category, topic) tuple."""
    groups = defaultdict(list)
    for qid, q in questions.items():
        key = (q.category, q.sub_topic)
        groups[key].append(qid)
    return dict(groups)
```

4. Add function to sanitize topic names for C identifiers:
```python
def sanitize_topic_name(category: str, topic: str) -> str:
    """Convert category+topic to valid C identifier."""
    combined = f"{category}_{topic}"
    sanitized = re.sub(r'[^a-zA-Z0-9]', '_', combined)
    sanitized = re.sub(r'_+', '_', sanitized)  # Collapse multiple underscores
    return sanitized.upper()
```

5. Add function to generate topic_pools.h:
```python
def generate_topic_pools_header(topic_groups: dict, out_dir: Path):
    """Generate topic_pools.h with pool declarations."""
    header_path = out_dir / 'include' / 'quiz' / 'topic_pools.h'
    header_path.parent.mkdir(parents=True, exist_ok=True)
    
    lines = [
        '#ifndef GUARD_TOPIC_POOLS_H',
        '#define GUARD_TOPIC_POOLS_H',
        '',
        '// Auto-generated by build_questions.py - DO NOT EDIT',
        '',
        '#include "global.h"',
        '#include "quiz/questions_gen.h"',
        '',
        '// Topic pool struct',
        'struct QuizTopicPool',
        '{',
        '    const struct QuizQuestion * const *questions;',
        '    u16 count;',
        '};',
        '',
        '// Map config struct',
        'struct QuizMapConfig',
        '{',
        '    u16 mapId;',
        '    const struct QuizTopicPool * const *topicPools;',
        '    u8 topicCount;',
        '};',
        '',
        '// Gym config struct',
        'struct QuizGymConfig',
        '{',
        '    u8 gymId;',
        '    u16 mapId;',
        '    const struct QuizTopicPool * const *masteryPools;',
        '    u8 poolCount;',
        '};',
        '',
        '// Topic pool declarations',
    ]
    
    for (category, topic), qids in sorted(topic_groups.items()):
        name = sanitize_topic_name(category, topic)
        lines.append(f'extern const struct QuizTopicPool gQuizTopicPool_{name};')
    
    lines.extend([
        '',
        '// Lookup functions',
        'const struct QuizTopicPool *Quiz_GetTopicPool(const char *category, const char *topic);',
        'const struct QuizMapConfig *Quiz_GetMapConfig(u16 mapId);',
        'const struct QuizGymConfig *Quiz_GetGymConfig(u8 gymId);',
        '',
        '#endif // GUARD_TOPIC_POOLS_H',
        ''
    ])
    
    with open(header_path, 'w', encoding='utf-8') as f:
        f.write('\n'.join(lines))
    
    print(f"Generated: {header_path}")
```

6. Add function to generate topic_pools.c:
```python
def generate_topic_pools_source(questions: dict, topic_groups: dict, topic_config: dict, out_dir: Path):
    """Generate topic_pools.c with topic pool data."""
    source_path = out_dir / 'src' / 'quiz' / 'topic_pools.c'
    source_path.parent.mkdir(parents=True, exist_ok=True)
    
    lines = [
        '// Auto-generated by build_questions.py - DO NOT EDIT',
        '',
        '#include "global.h"',
        '#include "quiz/questions_gen.h"',
        '#include "quiz/topic_pools.h"',
        '#include "constants/map_groups.h"',
        '',
    ]
    
    # Generate topic pools
    lines.append('// Topic pools')
    for (category, topic), qids in sorted(topic_groups.items()):
        name = sanitize_topic_name(category, topic)
        valid_qids = [qid for qid in qids if qid in questions]
        
        if valid_qids:
            # Question pointer array
            lines.append(f'static const struct QuizQuestion * const sTopicQuestions_{name}[] = {{')
            for qid in valid_qids:
                safe_id = sanitize_id(qid)
                lines.append(f'    &sQuestion_{safe_id},')
            lines.append('};')
            lines.append('')
            
            # Pool struct
            lines.extend([
                f'const struct QuizTopicPool gQuizTopicPool_{name} = {{',
                f'    .questions = sTopicQuestions_{name},',
                f'    .count = {len(valid_qids)},',
                '};',
                ''
            ])
    
    # Generate map configs from topic_config
    if 'question_pool_by_map' in topic_config:
        lines.append('// Map topic pool configurations')
        
        for map_name, topics in topic_config['question_pool_by_map'].items():
            safe_map = map_name.replace('MAP_', '')
            
            # Pool pointer array
            lines.append(f'static const struct QuizTopicPool * const sMapPools_{safe_map}[] = {{')
            for t in topics:
                pool_name = sanitize_topic_name(t['category'], t['topic'])
                lines.append(f'    &gQuizTopicPool_{pool_name},')
            lines.append('};')
            lines.append('')
            
            # Config struct
            lines.extend([
                f'static const struct QuizMapConfig sMapConfig_{safe_map} = {{',
                f'    .mapId = {map_name},',
                f'    .topicPools = sMapPools_{safe_map},',
                f'    .topicCount = {len(topics)},',
                '};',
                ''
            ])
        
        # Generate lookup function
        lines.extend([
            '// Map config lookup',
            'const struct QuizMapConfig *Quiz_GetMapConfig(u16 mapId)',
            '{',
            '    switch (mapId)',
            '    {',
        ])
        
        for map_name in topic_config['question_pool_by_map'].keys():
            safe_map = map_name.replace('MAP_', '')
            lines.append(f'    case {map_name}:')
            lines.append(f'        return &sMapConfig_{safe_map};')
        
        lines.extend([
            '    default:',
            '        return NULL;',
            '    }',
            '}',
            ''
        ])
    
    # Generate gym configs from gyms_by_map
    if 'gyms_by_map' in topic_config:
        lines.append('// Gym mastery pool configurations')
        
        for gym_map, gym_data in topic_config['gyms_by_map'].items():
            gym_id = gym_data['gym']
            mastery_pool = gym_data.get('mastery_pool', [])
            safe_gym = f"GYM_{gym_id}"
            
            if mastery_pool:
                # Pool pointer array
                lines.append(f'static const struct QuizTopicPool * const sGymPools_{safe_gym}[] = {{')
                for t in mastery_pool:
                    pool_name = sanitize_topic_name(t['category'], t['topic'])
                    lines.append(f'    &gQuizTopicPool_{pool_name},')
                lines.append('};')
                lines.append('')
                
                # Config struct
                lines.extend([
                    f'static const struct QuizGymConfig sGymConfig_{safe_gym} = {{',
                    f'    .gymId = {gym_id},',
                    f'    .mapId = {gym_map},',
                    f'    .masteryPools = sGymPools_{safe_gym},',
                    f'    .poolCount = {len(mastery_pool)},',
                    '};',
                    ''
                ])
        
        # Generate gym lookup function
        lines.extend([
            '// Gym config lookup',
            'const struct QuizGymConfig *Quiz_GetGymConfig(u8 gymId)',
            '{',
            '    switch (gymId)',
            '    {',
        ])
        
        for gym_map, gym_data in topic_config['gyms_by_map'].items():
            gym_id = gym_data['gym']
            safe_gym = f"GYM_{gym_id}"
            lines.append(f'    case {gym_id}:')
            lines.append(f'        return &sGymConfig_{safe_gym};')
        
        lines.extend([
            '    default:',
            '        return NULL;',
            '    }',
            '}',
            ''
        ])
    
    with open(source_path, 'w', encoding='utf-8') as f:
        f.write('\n'.join(lines))
    
    print(f"Generated: {source_path}")
```

7. Update main() to call new generation functions:
```python
def main():
    args = parse_args()
    
    # ... existing CSV parsing ...
    
    # Load topic config
    topic_config = load_topic_config(args.topics)
    
    # Group questions by topic
    topic_groups = group_by_topic(questions)
    print(f"Found {len(topic_groups)} unique category+topic combinations")
    
    # Generate files
    generate_header(questions, species_map, args.out_dir)
    generate_source(questions, species_map, args.out_dir)
    
    # Generate topic pools if config provided
    if topic_config:
        generate_topic_pools_header(topic_groups, args.out_dir)
        generate_topic_pools_source(questions, topic_groups, topic_config, args.out_dir)
```

8. Make question structs visible to topic_pools.c by changing `static` to non-static in questions_gen.c for the sQuestion_* structs, OR reference them via extern. Simplest approach: in questions_gen.c, change:
   - `static const struct QuizQuestion sQuestion_` to `const struct QuizQuestion sQuestion_`
   - Add declarations to questions_gen.h

IMPORTANT: This requires careful coordination. Alternative: generate all topic pool data INSIDE questions_gen.c as part of the same generation step, avoiding cross-file references.

Recommended approach: Generate topic pools INSIDE questions_gen.c (same file as question structs) to avoid extern complexity.
  </action>
  <verify>Run build tool: `cd pokefirered && python3 tools/quiz/build_questions.py data/questions/questions.csv --mapping data/questions/species_map.json --topics data/questions/map_topics.json --out-dir .` generates both questions_gen.* and topic_pools.* files</verify>
  <done>build_questions.py generates topic pools based on map_topics.json configuration</done>
</task>

<task type="auto">
  <name>Task 2: Generate topic pools and verify compilation</name>
  <files>
    pokefirered/include/quiz/topic_pools.h
    pokefirered/src/quiz/topic_pools.c
  </files>
  <action>
Run the updated build tool to generate topic pool files:

1. Execute the build script:
```bash
cd pokefirered
python3 tools/quiz/build_questions.py \
    data/questions/questions.csv \
    --mapping data/questions/species_map.json \
    --topics data/questions/map_topics.json \
    --out-dir .
```

2. Verify the generated files:
- `include/quiz/topic_pools.h` should have:
  - `struct QuizTopicPool` definition
  - `struct QuizMapConfig` definition  
  - `extern const struct QuizTopicPool gQuizTopicPool_*` for each category+topic
  - Function declarations

- `src/quiz/topic_pools.c` should have:
  - Static question pointer arrays per topic
  - `const struct QuizTopicPool gQuizTopicPool_*` structs
  - Map config structs
  - `Quiz_GetMapConfig(mapId)` lookup function

3. If there are cross-file reference issues with question structs, adjust the approach:
   
   Option A: Move topic pool generation into questions_gen.c (recommended)
   - Add topic pool structs and data directly in questions_gen.c
   - Add declarations to questions_gen.h
   - No separate topic_pools.h/c files needed
   
   Option B: Make question structs extern
   - Change `static const struct QuizQuestion sQuestion_*` to `const struct QuizQuestion sQuestion_*`
   - Add `extern const struct QuizQuestion sQuestion_*;` to questions_gen.h
   - This works but pollutes the header with many declarations

4. Verify the build:
```bash
cd pokefirered && make -j4
```
  </action>
  <verify>Full build: `cd pokefirered && make -j4 2>&1 | tail -20` completes without errors, topic_pools.o is created</verify>
  <done>Topic pool files generated and compile successfully, Quiz_GetMapConfig() is available</done>
</task>

<task type="auto">
  <name>Task 3: Add Quiz_GetQuestionsForMap helper function</name>
  <files>
    pokefirered/include/quiz/topic_pools.h
    pokefirered/src/quiz/topic_pools.c
  </files>
  <action>
Add a convenience function that selects a random question from a map's topic pools:

1. Add declaration to topic_pools.h (or questions_gen.h if integrated):
```c
// Select a random question from the map's topic pools
const struct QuizQuestion *Quiz_GetRandomQuestionForMap(u16 mapId);

// Get count of available questions for a map
u16 Quiz_GetQuestionCountForMap(u16 mapId);
```

2. Add implementation to topic_pools.c (or questions_gen.c):
```c
#include "random.h"  // For Random()

const struct QuizQuestion *Quiz_GetRandomQuestionForMap(u16 mapId)
{
    const struct QuizMapConfig *config;
    const struct QuizTopicPool *pool;
    u16 totalQuestions = 0;
    u16 selectedIndex;
    u8 i;
    
    config = Quiz_GetMapConfig(mapId);
    if (config == NULL || config->topicCount == 0)
        return NULL;
    
    // Count total questions across all topic pools
    for (i = 0; i < config->topicCount; i++)
    {
        pool = config->topicPools[i];
        if (pool != NULL)
            totalQuestions += pool->count;
    }
    
    if (totalQuestions == 0)
        return NULL;
    
    // Select random question index
    selectedIndex = Random() % totalQuestions;
    
    // Find the question at that index
    for (i = 0; i < config->topicCount; i++)
    {
        pool = config->topicPools[i];
        if (pool == NULL)
            continue;
        
        if (selectedIndex < pool->count)
            return pool->questions[selectedIndex];
        
        selectedIndex -= pool->count;
    }
    
    return NULL;  // Shouldn't reach here
}

u16 Quiz_GetQuestionCountForMap(u16 mapId)
{
    const struct QuizMapConfig *config;
    const struct QuizTopicPool *pool;
    u16 count = 0;
    u8 i;
    
    config = Quiz_GetMapConfig(mapId);
    if (config == NULL)
        return 0;
    
    for (i = 0; i < config->topicCount; i++)
    {
        pool = config->topicPools[i];
        if (pool != NULL)
            count += pool->count;
    }
    
    return count;
}
```

3. Rebuild and verify:
```bash
cd pokefirered && make -j4
```
  </action>
  <verify>Build compiles: `cd pokefirered && make -j4 2>&1 | grep -E "(error|undefined)" | head -5` shows no errors</verify>
  <done>Quiz_GetRandomQuestionForMap() and Quiz_GetQuestionCountForMap() available for quiz.c to use</done>
</task>

</tasks>

<verification>
1. `python3 tools/quiz/build_questions.py --topics` generates topic pool files
2. Topic pools contain questions grouped by Broad_Category + Sub_Topic
3. Quiz_GetMapConfig(mapId) returns correct pool references for configured maps
4. Quiz_GetGymConfig(gymId) returns correct mastery pool references for gym battles
5. Quiz_GetRandomQuestionForMap(mapId) returns a valid question
6. `cd pokefirered && make -j4` builds successfully
</verification>

<success_criteria>
- build_questions.py accepts --topics argument for map_topics.json
- All unique category+topic combinations become topic pools
- Each map in map_topics.json has a QuizMapConfig with pool references
- Each gym in gyms_by_map has a QuizGymConfig with mastery pool references
- Quiz_GetGymConfig(gymId) lookup is generated for gym battles (used by Plan 14-04 Task 3)
- Topic pool data is static const (ROM, not RAM)
- Build compiles and links without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-map-questions-to-encounters/14-03-SUMMARY.md`
</output>
