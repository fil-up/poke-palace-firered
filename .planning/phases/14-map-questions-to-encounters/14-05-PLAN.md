---
phase: 14-map-questions-to-encounters
plan: 05
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - pokefirered/src/wild_encounter.c
  - pokefirered/src/quiz/route_completion.c
autonomous: false

must_haves:
  truths:
    - "Species cleared in Section 1 can be encountered again in Section 7"
    - "Wild encounter filter only excludes species cleared in CURRENT section"
    - "Route completion tracking is section-aware"
    - "Encounter rate reduction only applies when species cleared in current section"
  artifacts:
    - path: "pokefirered/src/wild_encounter.c"
      provides: "Section-aware encounter filtering"
      contains: "Quiz_IsSpeciesClearedInSection"
    - path: "pokefirered/src/quiz/route_completion.c"
      provides: "Section-aware completion tracking"
      contains: "Quiz_GetCurrentSection"
  key_links:
    - from: "pokefirered/src/wild_encounter.c"
      to: "pokefirered/src/quiz/quiz.c"
      via: "Quiz_IsSpeciesCleared"
      pattern: "Quiz_IsSpeciesCleared"
    - from: "pokefirered/src/quiz/route_completion.c"
      to: "pokefirered/include/quiz/section_config.h"
      via: "Quiz_GetCurrentSection"
      pattern: "Quiz_GetCurrentSection"
---

<objective>
Enable species re-capture by making wild encounter filtering section-aware.

Purpose: With section-based cleared tracking, a species cleared in one section should be encounterable in later sections. The wild encounter filter and route completion tracking must check section-specific status.

Output:
- Updated wild_encounter.c using section-aware Quiz_IsSpeciesCleared
- Updated route_completion.c for section-aware completion tracking
- Player verification that re-capture works across sections
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-map-questions-to-encounters/14-CONTEXT.md
@.planning/phases/14-map-questions-to-encounters/14-02-SUMMARY.md
@pokefirered/src/wild_encounter.c
@pokefirered/src/quiz/route_completion.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Quiz_IsSpeciesCleared uses current section</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Verify that Quiz_IsSpeciesCleared() already uses section-aware logic (should have been updated in Plan 02).

Check that the function looks like:
```c
bool8 Quiz_IsSpeciesCleared(u16 species)
{
    u8 section = Quiz_GetCurrentSection();
    return Quiz_IsSpeciesClearedInSection(species, section);
}
```

If this is NOT already in place from Plan 02, add it now.

The key behavior:
- Called from wild_encounter.c to filter cleared species
- Now returns FALSE for species cleared in OTHER sections
- Only returns TRUE if cleared in CURRENT section

This means a Rattata cleared in Section 1 (Pallet Town area) will:
- Return TRUE when in Section 1 (filtered out)
- Return FALSE when in Section 7 (can be encountered again)
  </action>
  <verify>Grep for function: `grep -A5 "bool8 Quiz_IsSpeciesCleared" pokefirered/src/quiz/quiz.c` shows section-aware implementation</verify>
  <done>Quiz_IsSpeciesCleared checks section-specific cleared status via Quiz_GetCurrentSection</done>
</task>

<task type="auto">
  <name>Task 2: Update route_completion.c for section awareness</name>
  <files>pokefirered/src/quiz/route_completion.c</files>
  <action>
Update route completion tracking to be section-aware:

1. Add include at top:
```c
#include "quiz/section_config.h"
```

2. The route completion logic calls Quiz_IsSpeciesCleared() which is already section-aware.
   Verify the existing code in route_completion.c works correctly:

```c
// In RouteCompletion_IsTerrainComplete()
for (i = 0; i < uniqueCount; i++)
{
    // This now checks section-specific status
    if (!Quiz_IsSpeciesCleared(uniqueSpecies[i]))
        return FALSE;
}
```

3. If route completion needs to track completion per-section separately (e.g., "100% Route 1 in Section 1" is different from "100% Route 1 in Section 7"), you may need additional logic.

For the simplest approach: Route completion only matters in the section where the route is located. Since Section 1 routes are only in Section 1, this should work automatically.

However, if a route spans sections OR the same route concept exists in multiple sections, you might need:
```c
// Optional: Store section with completion data
u8 section = Quiz_GetCurrentSection();
// Check if completion was achieved in this section
```

4. The encounter rate reduction (25% when complete) should also be section-aware.
Find the encounter rate modification code and verify it uses Quiz_IsSpeciesCleared():
```c
// In wild_encounter.c or route_completion.c
if (RouteCompletion_IsTerrainComplete(mapId, terrain))
{
    // Reduce encounter rate to 25%
    // This is already section-aware via Quiz_IsSpeciesCleared
}
```

5. If there are any direct calls to old global state functions, replace them:
- `Quiz_GetSpeciesState(species) == QUIZ_STATE_CLEARED` â†’ `Quiz_IsSpeciesCleared(species)`
  </action>
  <verify>Grep for usages: `grep -n "Quiz_IsSpeciesCleared\|Quiz_GetSpeciesState" pokefirered/src/quiz/route_completion.c` shows section-aware calls</verify>
  <done>Route completion tracking uses section-aware Quiz_IsSpeciesCleared for all status checks</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Section-aware wild encounter filtering and route completion:
- Quiz_IsSpeciesCleared now checks current section only
- Species cleared in Section 1 can be encountered in later sections
- Route completion tracking respects section boundaries
  </what-built>
  <how-to-verify>
1. Build the ROM: `cd pokefirered && make -j4`
2. Start a new game (or use debug quick start)
3. Go to Route 1 and capture Rattata (answer 5 questions correctly)
4. Verify Rattata no longer appears on Route 1 (Section 1 cleared)
5. Use cheats/debug to advance to a later section (e.g., Section 7 area like Route 19)
   - Or if testing is difficult, temporarily modify Quiz_GetSectionForMap() to return different sections for Route 1 at different times
6. Return to Route 1 (or an area with Rattata in the later section)
7. Verify Rattata CAN be encountered again (re-capturable in new section)
8. Verify the new Rattata requires fresh 5-question mastery (mastery reset per section)

Alternative simpler test:
1. Modify Quiz_GetCurrentSection() to return a hardcoded section (e.g., 7)
2. Try to encounter a previously-cleared species
3. It should appear (not filtered out)
4. Remove the hardcoded section change
  </how-to-verify>
  <resume-signal>Type "approved" if re-capture works across sections, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Quiz_IsSpeciesCleared() implementation uses Quiz_GetCurrentSection()
2. Route completion uses section-aware cleared checks
3. Build compiles without errors
4. Cleared species can be encountered in different sections
5. Mastery is fresh for species in new sections
</verification>

<success_criteria>
- Species cleared in Section 1 are NOT filtered in Section 7
- Route completion only considers species cleared in current section
- Encounter rate reduction (25%) respects section boundaries
- Re-captured species require fresh 5-question mastery
- Full build succeeds
- Human verification confirms re-capture mechanics work
</success_criteria>

<output>
After completion, create `.planning/phases/14-map-questions-to-encounters/14-05-SUMMARY.md`
</output>
