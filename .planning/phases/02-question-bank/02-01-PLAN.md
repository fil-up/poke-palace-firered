---
phase: 02-question-bank
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pokefirered/src/quiz/quiz.c
  - pokefirered/include/quiz/quiz.h
autonomous: true
must_haves:
  truths:
    - "Quiz_InitWildEncounter loads a question from species bank"
    - "Current question is stored in quiz state"
    - "Answer verification uses current question's correctIndex"
  artifacts:
    - Modified quiz.c with bank integration
  key_links:
    - "Quiz_GetBank() from questions_gen.c returns correct bank for species"
---

<objective>
Integrate the generated question bank system into the existing quiz.c, replacing hardcoded questions with dynamic lookup by species. The quiz state will track the current question and use its correct answer index for verification.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@pokefirered/src/quiz/quiz.c
@pokefirered/include/quiz/questions_gen.h

Current State:
- quiz.c has hardcoded sQuizQuestionText and sQuizAnswerText arrays
- Quiz_InitWildEncounter ignores species/map parameters
- Quiz_OnMoveConfirmed hardcodes slot 0 as correct answer
- questions_gen.h provides Quiz_GetBank(species) and QuizQuestion struct

Target State:
- Quiz state stores pointer to current QuizQuestion
- Quiz_InitWildEncounter calls Quiz_GetBank and selects random question
- Quiz_OnCommandMenuShown displays current question's prompt
- Quiz_OnMoveCursorChanged displays current question's choice text
- Quiz_OnMoveConfirmed checks against current question's correctIndex
</context>

<tasks>
<task type="auto">
  <name>Update QuizState struct with current question</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Modify the QuizState struct to include:
```c
struct QuizState
{
    bool8 active;
    u8 lastHoverIndex;
    enum QuizTurnResult turnResult;
    const struct QuizQuestion *currentQuestion;  // NEW
    u16 currentSpecies;                          // NEW - for tracking
};
```

Add include for questions_gen.h:
```c
#include "quiz/questions_gen.h"
```

Remove the hardcoded question strings (sQuizQuestionText, sQuizAnswerText0-3, sQuizAnswerText array).
Keep the prompt building strings (sQuizPromptPrefix, etc.) and sQuizTextBuffer.
  </action>
  <verify>File compiles without errors about removed symbols</verify>
  <done>
- QuizState has currentQuestion pointer
- Hardcoded question strings removed
- questions_gen.h included
  </done>
</task>

<task type="auto">
  <name>Implement question selection in Quiz_InitWildEncounter</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Update Quiz_InitWildEncounter to:
1. Look up the question bank for the species
2. If bank exists and has questions, select one randomly
3. Store the selected question in sQuizState.currentQuestion

```c
void Quiz_InitWildEncounter(u16 species, u8 mapGroup, u8 mapNum)
{
    const struct QuizBank *bank;
    
    sQuizState.active = FALSE;
    sQuizState.lastHoverIndex = 0xFF;
    sQuizState.turnResult = QUIZ_TURN_NONE;
    sQuizState.currentQuestion = NULL;
    sQuizState.currentSpecies = species;
    
    bank = Quiz_GetBank(species);
    if (bank != NULL && bank->count > 0)
    {
        // Select random question from bank
        u8 index = Random() % bank->count;
        sQuizState.currentQuestion = bank->questions[index];
        sQuizState.active = TRUE;
    }
    
    (void)mapGroup;
    (void)mapNum;
}
```

Note: For now, random selection. Mastery-based filtering comes in Phase 4.
  </action>
  <verify>Breakpoint or debug print shows question being selected</verify>
  <done>
- Quiz_InitWildEncounter looks up bank by species
- Random question selected from bank
- currentQuestion populated in state
  </done>
</task>

<task type="auto">
  <name>Update display functions to use current question</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
Update Quiz_OnCommandMenuShown:
```c
void Quiz_OnCommandMenuShown(void)
{
    if (gBattleTypeFlags & (BATTLE_TYPE_TRAINER | BATTLE_TYPE_SAFARI))
        return;
    if (sQuizState.currentQuestion == NULL)
        return;

    sQuizState.lastHoverIndex = 0xFF;
    sQuizState.turnResult = QUIZ_TURN_NONE;
    UpdateOamPriorityInAllHealthboxes(2);
    BattlePutTextOnWindow(sQuizState.currentQuestion->prompt, B_WIN_QUIZ);
}
```

Update Quiz_BuildAnswerPrompt to use current question:
```c
static void Quiz_BuildAnswerPrompt(u8 moveSlot, u16 moveId)
{
    u8 *cursor;
    
    if (sQuizState.currentQuestion == NULL)
        return;

    cursor = StringCopy(sQuizTextBuffer, sQuizPromptPrefix);
    cursor = StringAppend(cursor, gMoveNames[moveId]);
    cursor = StringAppend(cursor, sQuizPromptMiddle);
    cursor[0] = sQuizAnswerLetters[moveSlot];
    cursor[1] = EOS;
    cursor = StringAppend(cursor, sQuizPromptSuffix);
    cursor[0] = CHAR_NEWLINE;
    cursor[1] = EOS;
    StringAppend(cursor, sQuizState.currentQuestion->choices[moveSlot]);
}
```

Update Quiz_OnMoveConfirmed to use correct index:
```c
void Quiz_OnMoveConfirmed(u8 moveSlot, u16 moveId)
{
    if (!sQuizState.active)
        return;
    if (sQuizState.currentQuestion == NULL)
        return;
    if (moveSlot >= QUIZ_ANSWER_COUNT)
        return;
    if (moveId == MOVE_NONE)
        return;

    if (moveSlot == sQuizState.currentQuestion->correctIndex)
        sQuizState.turnResult = QUIZ_TURN_CORRECT;
    else
        sQuizState.turnResult = QUIZ_TURN_WRONG;
}
```
  </action>
  <verify>Build succeeds, functions reference currentQuestion</verify>
  <done>
- Quiz_OnCommandMenuShown displays currentQuestion->prompt
- Quiz_BuildAnswerPrompt displays currentQuestion->choices[moveSlot]
- Quiz_OnMoveConfirmed checks currentQuestion->correctIndex
  </done>
</task>
</tasks>

<verification>
1. `make` compiles without errors
2. Quiz_GetBank is called and returns valid bank for mapped species
3. Question prompt displays from bank instead of hardcoded text
4. Correct answer index matches question data, not hardcoded slot 0
</verification>

<success_criteria>
- Hardcoded question strings removed from quiz.c
- Quiz uses generated question bank data
- Random question selected per encounter
- Correct answer determined by question data
</success_criteria>
