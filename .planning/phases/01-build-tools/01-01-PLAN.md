---
phase: 01-build-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pokefirered/tools/quiz/validate_questions.py
  - pokefirered/tools/quiz/build_questions.py
  - pokefirered/tools/quiz/requirements.txt
autonomous: true
must_haves:
  truths:
    - "Running validate_questions.py on valid CSV exits 0"
    - "Running validate_questions.py on invalid CSV exits non-zero with error message"
    - "Running build_questions.py generates valid C source files"
  artifacts:
    - pokefirered/tools/quiz/validate_questions.py
    - pokefirered/tools/quiz/build_questions.py
  key_links:
    - "Generated C code must match struct format expected by quiz.c"
---

<objective>
Create Python build tools that validate CSV question bank format and generate C source files containing question data tables. This establishes the automated pipeline from CSV authoring to compiled game data.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md

CSV Format (from GH 101 Question Bank):
- Question_ID: Unique identifier (e.g., MQ.3.001)
- Broad_Category: Topic category
- Sub_Topic: Specific topic
- Question_String: The question text (must be ≤120 chars for GBA)
- Option_Label: A, B, C, or D
- Option_Text: Answer choice text (must be ≤40 chars for GBA)
- Correct_Answer: A, B, C, or D
- Difficulty_Level: 1-5
- Explanation: Text shown on correct answer

Each question has 4 rows (one per option A/B/C/D), sharing the same Question_ID.

Target C struct format:
```c
struct QuizQuestion {
    const u8 *prompt;
    const u8 *choices[4];
    u8 correctIndex;      // 0-3
    u8 difficulty;        // 1-5
    const u8 *explanation;
};

struct QuizBank {
    const struct QuizQuestion *questions;
    u8 count;
};
```
</context>

<tasks>
<task type="auto">
  <name>Create CSV validation script</name>
  <files>pokefirered/tools/quiz/validate_questions.py</files>
  <action>
Create Python script that:
1. Reads CSV file path from command line argument
2. Parses CSV using csv module
3. Groups rows by Question_ID
4. Validates each question:
   - Exactly 4 options (A, B, C, D)
   - Question_String ≤ 120 characters
   - Each Option_Text ≤ 40 characters
   - Correct_Answer is A, B, C, or D
   - Difficulty_Level is 1-5
   - All required fields present and non-empty
5. Reports all errors with line numbers
6. Exits 0 on success, 1 on validation failure

Include --strict flag that also warns on:
- Questions approaching length limits (>100 chars prompt, >35 chars answer)
- Duplicate Question_IDs
  </action>
  <verify>
Run: `python tools/quiz/validate_questions.py ../GH\ 101\ Question\ Bank\ -\ Sheet1.csv`
Should exit 0 if CSV is valid, print summary of questions validated
  </verify>
  <done>
- Script exists and is executable
- Valid CSV passes validation
- Invalid CSV (missing field, too-long text) fails with descriptive error
  </done>
</task>

<task type="auto">
  <name>Create C code generation script</name>
  <files>pokefirered/tools/quiz/build_questions.py</files>
  <action>
Create Python script that:
1. Reads validated CSV file path from command line
2. Reads optional species mapping JSON (species_id -> [question_ids])
3. Parses CSV and groups by Question_ID
4. Generates questions_gen.h with:
   - Include guards
   - Forward declarations
   - Extern declarations for question banks
5. Generates questions_gen.c with:
   - #include "global.h" and quiz headers
   - Static const u8 strings using _() macro for each text
   - QuizQuestion structs
   - QuizBank arrays organized by species
6. Uses GBA string format: `static const u8 sQ_MQ3001_Prompt[] = _("...");`
7. Sanitizes Question_IDs to valid C identifiers (replace . with _)
8. Output files go to include/quiz/ and src/quiz/ directories

Command line: `python build_questions.py input.csv --mapping species_map.json --out-dir ../`
  </action>
  <verify>
Run script on test CSV, verify:
- questions_gen.h has valid include guards and extern declarations
- questions_gen.c compiles (check with `make` after integration)
  </verify>
  <done>
- Script generates syntactically correct C files
- Generated strings use _() macro
- Question IDs become valid C identifiers
- Header has proper include guards
  </done>
</task>

<task type="auto">
  <name>Create requirements.txt and README</name>
  <files>pokefirered/tools/quiz/requirements.txt</files>
  <action>
Create requirements.txt with Python dependencies (likely just stdlib, but document Python version requirement).
Add brief README.md in tools/quiz/ documenting:
- Purpose of each script
- Usage examples
- CSV format requirements
- Species mapping JSON format
  </action>
  <verify>File exists with appropriate content</verify>
  <done>
- requirements.txt documents Python 3.8+ requirement
- README explains usage
  </done>
</task>
</tasks>

<verification>
1. `python tools/quiz/validate_questions.py --help` shows usage
2. `python tools/quiz/build_questions.py --help` shows usage
3. Running both scripts on the GH 101 CSV produces valid output
4. Generated C files have no syntax errors (verified by including in build)
</verification>

<success_criteria>
- validate_questions.py catches invalid CSV entries and exits non-zero
- build_questions.py generates questions_gen.h and questions_gen.c
- Generated files follow GBA/decomp coding conventions
- Tools are documented and reproducible
</success_criteria>
