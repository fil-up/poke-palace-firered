---
phase: 10-pewter-content
plan: 01
type: execute
wave: 1
depends_on: [09-01]
files_modified:
  - pokefirered/data/questions/species_map.json
  - pokefirered/src/quiz/quiz.c
  - pokefirered/include/quiz/quiz.h
  - pokefirered/src/quiz/questions_gen.c (regenerated)
  - pokefirered/include/quiz/questions_gen.h (regenerated)
autonomous: true
must_haves:
  truths:
    - Route 2 species need question banks (Nidoran-F, Nidoran-M)
    - Gym leader battles require multi-question mechanic
    - Brock's Pokemon need 2 questions each (3 for final Pokemon)
    - Questions drawn from all prior area pools
  artifacts:
    - Updated species_map.json with Nidoran entries
    - Gym leader detection and multi-question state machine
    - Area pool aggregation function
  key_links:
    - pokefirered/src/quiz/quiz.c (main quiz logic)
    - pokefirered/include/quiz/quiz.h (API declarations)
---

<objective>
Complete MVP geographic scope by populating Route 2 question banks (Nidoran-F, Nidoran-M) and implementing gym leader multi-question mechanic where Brock's Pokemon require 2-3 questions per attack drawn from all prior area pools.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-viridian-forest/09-01-SUMMARY.md

## Scope

1. **Content**: Populate Route 2 species question banks
2. **Feature**: Gym leader multi-question mechanic (Brock only for now)

## Core Behavior

- Gym leader battles require 2 questions per Pokemon (3 for final Pokemon)
- Questions pulled randomly from all prior area question banks
- Player must answer all questions correctly for attack to succeed
- Any wrong answer = attack fails (no damage dealt)
</context>

<tasks>
<task type="auto">
  <name>Add Route 2 species to species_map.json</name>
  <files>pokefirered/data/questions/species_map.json</files>
  <action>
    Add Nidoran-F and Nidoran-M with 5 question IDs each from MQ.20 chapter.
  </action>
  <verify>JSON is valid</verify>
  <done>Both Nidoran species have 5 questions</done>
</task>

<task type="auto">
  <name>Add gym leader detection</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
    Check gTrainers[gTrainerBattleOpponent_A].trainerClass == TRAINER_CLASS_LEADER
    Store in QuizState.isGymLeader
  </action>
  <verify>Gym leader flag is set correctly in battle</verify>
  <done>isGymLeader TRUE when fighting Brock</done>
</task>

<task type="auto">
  <name>Extend QuizState for multi-question</name>
  <files>pokefirered/src/quiz/quiz.c, pokefirered/include/quiz/quiz.h</files>
  <action>
    Add fields: gymQuestionsRequired, gymQuestionsAnswered, currentEnemyPartyIndex
    Add enum values: QUIZ_TURN_GYM_CORRECT, QUIZ_TURN_GYM_ALL_CORRECT, QUIZ_TURN_GYM_WRONG
  </action>
  <verify>Struct compiles correctly</verify>
  <done>State machine supports multi-question flow</done>
</task>

<task type="auto">
  <name>Create area pool aggregation</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
    Implement Quiz_BuildAreaPool() to collect questions from:
    - Route 1: Rattata, Pidgey
    - Viridian Forest: Caterpie, Weedle, Metapod, Kakuna, Pikachu
    - Route 2: Nidoran-F, Nidoran-M
  </action>
  <verify>Pool contains questions from all banks</verify>
  <done>gymPool array populated on gym battle init</done>
</task>

<task type="auto">
  <name>Detect final Pokemon for 3 questions</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
    Check if currentEnemyPartyIndex equals partySize - 1
    Set gymQuestionsRequired = 3 for final Pokemon, 2 otherwise
  </action>
  <verify>Onix requires 3 questions, Geodude requires 2</verify>
  <done>Final Pokemon detection works</done>
</task>

<task type="auto">
  <name>Update damage override for multi-question</name>
  <files>pokefirered/src/quiz/quiz_hooks.c</files>
  <action>
    Modify QuizHooks_ApplyDamageOverride to check gymQuestionsAnswered vs gymQuestionsRequired
    Return 0 damage if not all questions answered
  </action>
  <verify>Attack only succeeds when all questions correct</verify>
  <done>Damage gated by question count</done>
</task>

<task type="auto">
  <name>Update UI for sequential questions</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
    After correct answer in gym mode, if more questions remain:
    - Clear quiz window
    - Show next random question from pool
    - Don't apply damage until all answered
  </action>
  <verify>UI shows multiple questions in sequence</verify>
  <done>Sequential question display works</done>
</task>

<task type="auto">
  <name>Regenerate and compile</name>
  <files>pokefirered/src/quiz/questions_gen.c, pokefirered/include/quiz/questions_gen.h</files>
  <action>
    Run build_questions.py and make to verify compilation.
  </action>
  <verify>make completes successfully</verify>
  <done>ROM compiles with Phase 10 content</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Gym leader multi-question mechanic with Brock</what-built>
  <how-to-verify>
    1. Progress to Pewter Gym
    2. Battle Brock's Geodude - should require 2 correct answers per attack
    3. Battle Brock's Onix - should require 3 correct answers per attack
    4. Verify questions come from Route 1/Viridian/Route 2 pools
  </how-to-verify>
  <resume-signal>Say "tested" to confirm gym mechanic works</resume-signal>
</task>
</tasks>

<verification>
1. species_map.json has Nidoran-F and Nidoran-M with 5 questions each
2. Quiz_IsGymLeaderMode() returns TRUE for Brock battle
3. Geodude requires 2 questions, Onix requires 3
4. Questions drawn from aggregate pool (all prior areas)
5. Wrong answer at any point fails the attack
6. ROM compiles and runs
</verification>

<success_criteria>
- CONT-03: Route 2 species banks populated ✓
- CONT-03: Player can progress from Pallet Town to Pewter Gym with quiz mechanics ✓
- Gym mechanic: 2 questions per Pokemon, 3 for final ✓
- Pool aggregation: All prior area questions available ✓
</success_criteria>
