---
phase: 06-encounter-filter
plan: 01
type: execute
wave: 1
depends_on: [05-01]
files_modified:
  - pokefirered/include/quiz/quiz.h
  - pokefirered/src/quiz/quiz.c
  - pokefirered/src/wild_encounter.c
autonomous: true
must_haves:
  truths:
    - Cleared species (QUIZ_STATE_CLEARED) should not appear in wild encounters
    - Reroll logic must cap at 10 attempts to prevent infinite loops
    - If all species are cleared, encounter should be gracefully skipped
  artifacts:
    - Quiz_IsSpeciesCleared() function
    - Modified TryGenerateWildMon() with reroll logic
  key_links:
    - pokefirered/src/wild_encounter.c (encounter generation)
    - pokefirered/include/global.h (QuizSpeciesState enum)
---

<objective>
Implement encounter filtering so that species marked as CLEARED in the quiz system are skipped during wild encounter generation, with reroll logic capped at 10 attempts and graceful handling when all species in an area are cleared.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-capture-flow/05-01-SUMMARY.md

The quiz system already tracks species state via `Quiz_GetSpeciesState(species)` which returns:
- QUIZ_STATE_NONE (0) - Not encountered
- QUIZ_STATE_MASTERING (1) - Answering questions
- QUIZ_STATE_CAPTURE_PENDING (2) - Ready for capture
- QUIZ_STATE_CLEARED (3) - Species captured/completed

Wild encounters are generated in `wild_encounter.c`:
- `TryGenerateWildMon()` selects a slot via `ChooseWildMonIndex_*()` functions
- Species comes from `info->wildPokemon[slot].species`
- `GenerateWildMon()` creates the enemy Pokémon

The goal is to add a reroll loop that picks a different slot if the selected species is cleared.
</context>

<tasks>
<task type="auto">
  <name>Add Quiz_IsSpeciesCleared helper function</name>
  <files>pokefirered/include/quiz/quiz.h, pokefirered/src/quiz/quiz.c</files>
  <action>
    1. In quiz.h, add declaration:
       ```c
       bool8 Quiz_IsSpeciesCleared(u16 species);
       ```
    2. In quiz.c, implement:
       ```c
       bool8 Quiz_IsSpeciesCleared(u16 species)
       {
           return Quiz_GetSpeciesState(species) == QUIZ_STATE_CLEARED;
       }
       ```
  </action>
  <verify>Compiles without errors</verify>
  <done>Function exists and returns TRUE only for CLEARED species</done>
</task>

<task type="auto">
  <name>Include quiz header in wild_encounter.c</name>
  <files>pokefirered/src/wild_encounter.c</files>
  <action>
    Add include at top of file:
    ```c
    #include "quiz/quiz.h"
    ```
  </action>
  <verify>Compiles without errors</verify>
  <done>Quiz functions accessible from wild_encounter.c</done>
</task>

<task type="auto">
  <name>Implement reroll logic in TryGenerateWildMon for land encounters</name>
  <files>pokefirered/src/wild_encounter.c</files>
  <action>
    Modify TryGenerateWildMon() to loop with reroll logic:
    
    ```c
    #define MAX_REROLL_ATTEMPTS 10
    
    static bool8 TryGenerateWildMon(const struct WildPokemonInfo * info, u8 area, u8 flags)
    {
        u8 slot = 0;
        u8 level;
        u16 species;
        u8 attempts;
        
        for (attempts = 0; attempts < MAX_REROLL_ATTEMPTS; attempts++)
        {
            switch (area)
            {
            case WILD_AREA_LAND:
                slot = ChooseWildMonIndex_Land();
                break;
            case WILD_AREA_WATER:
                slot = ChooseWildMonIndex_WaterRock();
                break;
            case WILD_AREA_ROCKS:
                slot = ChooseWildMonIndex_WaterRock();
                break;
            }
            
            species = info->wildPokemon[slot].species;
            
            // If species is not cleared, use it
            if (!Quiz_IsSpeciesCleared(species))
                break;
        }
        
        // If we exhausted all attempts, all species likely cleared
        if (attempts >= MAX_REROLL_ATTEMPTS)
            return FALSE;
        
        level = ChooseWildMonLevel(&info->wildPokemon[slot]);
        if (flags == WILD_CHECK_REPEL && !IsWildLevelAllowedByRepel(level))
        {
            return FALSE;
        }
        GenerateWildMon(species, level, slot);
        return TRUE;
    }
    ```
  </action>
  <verify>Compiles without errors</verify>
  <done>Cleared species are skipped, reroll capped at 10 attempts</done>
</task>

<task type="auto">
  <name>Handle fishing encounters with reroll logic</name>
  <files>pokefirered/src/wild_encounter.c</files>
  <action>
    Modify GenerateFishingEncounter() to include similar reroll logic:
    
    ```c
    static u16 GenerateFishingEncounter(const struct WildPokemonInfo * info, u8 rod)
    {
        u8 slot;
        u8 level;
        u16 species;
        u8 attempts;
        
        for (attempts = 0; attempts < MAX_REROLL_ATTEMPTS; attempts++)
        {
            slot = ChooseWildMonIndex_Fishing(rod);
            species = info->wildPokemon[slot].species;
            
            if (!Quiz_IsSpeciesCleared(species))
                break;
        }
        
        // If all cleared, return SPECIES_NONE (caller should handle)
        if (attempts >= MAX_REROLL_ATTEMPTS)
            return SPECIES_NONE;
        
        level = ChooseWildMonLevel(&info->wildPokemon[slot]);
        GenerateWildMon(species, level, slot);
        return species;
    }
    ```
    
    Update FishingWildEncounter() to handle SPECIES_NONE:
    ```c
    void FishingWildEncounter(u8 rod)
    {
        u16 species = GenerateFishingEncounter(gWildMonHeaders[GetCurrentMapWildMonHeaderId()].fishingMonsInfo, rod);
        if (species == SPECIES_NONE)
        {
            // All fish cleared - no battle
            return;
        }
        IncrementGameStat(GAME_STAT_FISHING_CAPTURES);
        StartWildBattle();
    }
    ```
  </action>
  <verify>Compiles without errors</verify>
  <done>Fishing encounters also skip cleared species</done>
</task>

<task type="auto">
  <name>Verify compilation and test</name>
  <files>N/A</files>
  <action>
    1. Run `make` to verify compilation
    2. Verify no new warnings related to quiz or wild_encounter
  </action>
  <verify>`make` completes successfully</verify>
  <done>ROM compiles with encounter filter logic</done>
</task>
</tasks>

<verification>
1. `make` compiles successfully with no errors
2. Quiz_IsSpeciesCleared() function is declared and implemented
3. TryGenerateWildMon() includes reroll loop with MAX_REROLL_ATTEMPTS
4. GenerateFishingEncounter() includes reroll loop
5. All cleared scenarios return FALSE/skip encounter gracefully
</verification>

<success_criteria>
- FILT-01: Cleared species skipped during wild encounter generation ✓
- FILT-02: Reroll capped at 10 attempts to prevent infinite loops ✓
- FILT-03: If all species in area cleared, return "no encounter" ✓
</success_criteria>
