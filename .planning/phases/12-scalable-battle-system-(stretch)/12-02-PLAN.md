---
phase: 12-scalable-battle-system-(stretch)
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - pokefirered/src/quiz/quiz.c
  - pokefirered/include/quiz/quiz.h
  - pokefirered/src/battle_setup.c
autonomous: true
must_haves:
  truths:
    - "Trainer-facing encounters compute per-Pokémon question totals using base + modifiers, with last-Pokémon bonus for non-regular trainers."
    - "Gym leaders/rival/boss trainers continue using trainer pools; gym trainers use species banks with multi-question logic."
    - "Ghost/special encounters initialize quiz state and apply trainer scaling (not wild logic)."
  artifacts:
    - path: "pokefirered/src/quiz/quiz.c"
      provides: "Trainer question scaling integration and multi-question handling."
    - path: "pokefirered/include/quiz/quiz.h"
      provides: "Updated trainer multi-question API comments/semantics."
    - path: "pokefirered/src/battle_setup.c"
      provides: "Ghost/special battle quiz initialization."
  key_links:
    - from: "pokefirered/src/quiz/quiz.c"
      to: "pokefirered/src/quiz/trainer_scaling.c"
      via: "trainer tier + evolution helpers"
      pattern: "Quiz_GetTrainerTier|Quiz_GetEvolution"
    - from: "pokefirered/src/battle_setup.c"
      to: "pokefirered/src/quiz/quiz_hooks.c"
      via: "QuizHooks_OnWildBattleStart"
      pattern: "QuizHooks_OnWildBattleStart"
---

<objective>
Integrate scalable trainer question counts into quiz initialization and ensure special encounters initialize quiz state using trainer rules.

Purpose: Replace hardcoded 3/5 trainer counts with rule-based scaling across trainer, gym, and ghost encounters.
Output: Updated quiz initialization + ghost battle hooks with scaling logic enabled.
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-scalable-battle-system-(stretch)/12-CONTEXT.md
@.planning/phases/12-scalable-battle-system-(stretch)/12-RESEARCH.md
@pokefirered/src/quiz/quiz.c
@pokefirered/include/quiz/quiz.h
@pokefirered/src/battle_setup.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace trainer count logic with scaling rules</name>
  <files>
pokefirered/src/quiz/quiz.c
pokefirered/include/quiz/quiz.h
  </files>
  <action>
Integrate `quiz/trainer_scaling.h` into `quiz.c` and replace hardcoded 3/5 counts:
- Add quiz state fields to distinguish trainer multi-question mode and encounter tier (do not conflate "gym leader" with "multi-question").
- Compute `isTrainerBattle` using `BATTLE_TYPE_TRAINER` or `Quiz_IsSpecialTrainerEncounter(gBattleTypeFlags)`.
- Determine `trainerTier` via `Quiz_GetTrainerTier(gTrainerBattleOpponent_A, trainerClass, gBattleTypeFlags)`.
- Determine `isLastPokemon` using `GetBattlerAtPosition(B_POSITION_OPPONENT_LEFT)` and `gBattlerPartyIndexes[opponentBattler]` vs `trainerPartySize - 1` (avoid species matching).
- Calculate required questions:
  - Base by tier: regular=1, gym trainer=2, gym leader=5, rival/boss=5, special=5.
  - Evolution stage modifier: +0/+1/+2 using `Quiz_GetEvolutionStage(species)`.
  - Line length modifier: +2 for line length=1 (non-legendary), +1 for line length=2.
  - Legendary override: `Quiz_IsLegendarySpecies(species)` returns 10 total (skip other modifiers).
  - Last-Pokémon bonus: +2 for non-regular tiers only.
- When total questions > 1, enable trainer multi-question mode. Keep gym leader/rival/boss using trainer pools; gym trainers and specials should use species banks.
- Update `Quiz_GetEncounterType` so only gym leaders return the gym encounter label; other trainer tiers return trainer encounter.
- Update `Quiz_IsGymLeaderMode` comment/semantics to reflect "trainer multi-question" without changing its signature, and ensure quiz_hooks behavior still matches multi-question flow.
  </action>
  <verify>rg "Quiz_GetTrainerTier|Quiz_IsLegendarySpecies|gBattlerPartyIndexes" pokefirered/src/quiz/quiz.c</verify>
  <done>Trainer question counts derive from tier + evolution modifiers and last-Pokémon bonus; no fixed 3/5 counts remain.</done>
</task>

<task type="auto">
  <name>Task 2: Unify trainer multi-question selection source</name>
  <files>
pokefirered/src/quiz/quiz.c
  </files>
  <action>
Generalize trainer multi-question selection:
- Add a quiz state field for trainer question source (pool vs species bank).
- Replace `Quiz_SelectGymPoolQuestion` usages with a new selector that chooses from pool when configured, otherwise from the current species bank.
- Ensure `Quiz_AdvanceToNextGymQuestion` uses the selector and preserves `gymQuestionsAnswered`/`gymQuestionsRequired` behavior.
- When using species banks, avoid mastery changes (trainer battles do not mark mastery).
  </action>
  <verify>rg "trainerQuestionSource|Quiz_AdvanceToNext" pokefirered/src/quiz/quiz.c</verify>
  <done>Multi-question trainer flow works for both pool-based (leaders/rivals/boss) and species-based (gym trainers/special) sources.</done>
</task>

<task type="auto">
  <name>Task 3: Initialize quiz for ghost/special encounters</name>
  <files>
pokefirered/src/battle_setup.c
  </files>
  <action>
Ensure special encounters initialize quiz state:
- In `DoGhostBattle` and `StartMarowakBattle`, call `QuizHooks_OnWildBattleStart(GetMonData(&gEnemyParty[0], MON_DATA_SPECIES, NULL), mapGroup, mapNum)` after `gBattleTypeFlags` is set and before `CreateBattleStartTask`.
- Guard against `SPECIES_NONE` or empty party (skip init if no valid species).
This enables `Quiz_InitWildEncounter` to route ghost battles through trainer scaling rules.
  </action>
  <verify>rg "DoGhostBattle|StartMarowakBattle|QuizHooks_OnWildBattleStart" pokefirered/src/battle_setup.c</verify>
  <done>Ghost/special encounters initialize quiz state and are eligible for trainer scaling.</done>
</task>

</tasks>

<verification>
Trainer battles and ghost encounters use scalable question counts, last-Pokémon bonus is accurate, and multi-question logic still functions without UI regressions.
</verification>

<success_criteria>
- Hardcoded 3/5 trainer question counts are fully removed.
- Gym leaders remain pool-based; gym trainers and specials use species banks with multi-question logic.
- Ghost Marowak (and other ghost battles) initialize quiz state.
</success_criteria>

<output>
After completion, create `.planning/phases/12-scalable-battle-system-(stretch)/12-02-SUMMARY.md`
</output>
