---
phase: 12-scalable-battle-system-(stretch)
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pokefirered/include/quiz/trainer_scaling.h
  - pokefirered/src/quiz/trainer_scaling.c
autonomous: true
must_haves:
  truths:
    - "Trainer and special encounters produce consistent scaling inputs so question counts don't fluctuate between retries."
    - "Legendary trainer Pokemon consistently use the legendary question total rule."
    - "Evolution stage and line length influence trainer question totals consistently without per-species overrides."
  artifacts:
    - path: "pokefirered/include/quiz/trainer_scaling.h"
      provides: "Trainer-scaling helper declarations."
    - path: "pokefirered/src/quiz/trainer_scaling.c"
      provides: "Trainer classification, legendary list, and evolution helpers."
  key_links:
    - from: "pokefirered/src/quiz/trainer_scaling.c"
      to: "pokefirered/src/data/pokemon/evolution.h"
      via: "gEvolutionTable scan"
      pattern: "gEvolutionTable"
    - from: "pokefirered/src/quiz/trainer_scaling.c"
      to: "pokefirered/include/constants/opponents.h"
      via: "gym trainer id list"
      pattern: "TRAINER_"
---

<objective>
Define reusable helpers for trainer scaling that classify trainer tiers, detect legendary species, and compute evolution stage/line-length data needed by Phase 12.

Purpose: Centralize scaling logic inputs so quiz integration can stay minimal and engine-safe.
Output: New quiz helper module with trainer/legendary/evolution utilities.
</objective>

<execution_context>
@C:\Users\phill\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\phill\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-scalable-battle-system-(stretch)/12-CONTEXT.md
@.planning/phases/12-scalable-battle-system-(stretch)/12-RESEARCH.md
@pokefirered/include/constants/opponents.h
@pokefirered/src/data/pokemon/evolution.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trainer-tier + legendary helpers</name>
  <files>
pokefirered/include/quiz/trainer_scaling.h
pokefirered/src/quiz/trainer_scaling.c
  </files>
  <action>
Create `quiz/trainer_scaling.h` and `quiz/trainer_scaling.c` with:
- Enum `QuizTrainerTier` (REGULAR, GYM_TRAINER, GYM_LEADER, RIVAL_BOSS, SPECIAL).
- `bool8 Quiz_IsGymTrainerId(u16 trainerId)` using an explicit list of gym trainer IDs from `constants/opponents.h`.
- `bool8 Quiz_IsLegendarySpecies(u16 species)` using an explicit list of legendary species (Gen 1-3 set used in FRLG data).
- `bool8 Quiz_IsSpecialTrainerEncounter(u32 battleTypeFlags)` returning TRUE for `BATTLE_TYPE_GHOST` (and any other special battle types explicitly listed here).
- `enum QuizTrainerTier Quiz_GetTrainerTier(u16 trainerId, u8 trainerClass, u32 battleTypeFlags)`:
  - SPECIAL if `Quiz_IsSpecialTrainerEncounter` is true.
  - GYM_LEADER for `TRAINER_CLASS_LEADER`.
  - RIVAL_BOSS for trainer classes already treated as bosses/rivals (use existing class set from quiz.c).
  - GYM_TRAINER if `Quiz_IsGymTrainerId(trainerId)`.
  - REGULAR otherwise.
Avoid any new allocations; use static const arrays and linear scans.
  </action>
  <verify>rg "QuizTrainerTier|Quiz_IsGymTrainerId|Quiz_IsLegendarySpecies|Quiz_IsSpecialTrainerEncounter" pokefirered/src/quiz/trainer_scaling.c</verify>
  <done>Trainer-tier and legendary helpers compile cleanly and return deterministic results from ids/classes/flags.</done>
</task>

<task type="auto">
  <name>Task 2: Add evolution stage + line-length helpers</name>
  <files>
pokefirered/include/quiz/trainer_scaling.h
pokefirered/src/quiz/trainer_scaling.c
  </files>
  <action>
Implement evolution analysis helpers in the same module:
- `u8 Quiz_GetEvolutionStage(u16 species)` returning 0 (basic), 1 (stage1), or 2 (stage2+).
  - Stage 0: no species evolves into this species.
  - Stage 1: at least one pre-evolution exists, but none of those have a pre-evolution.
  - Stage 2: at least one pre-evolution exists that itself has a pre-evolution.
- `u8 Quiz_GetEvolutionLineLength(u16 species)` returning 1/2/3 (cap at 3 for branching):
  - Determine if the species has any pre-evolution (reverse scan of gEvolutionTable).
  - Determine if the species has any evolution (forward scan of gEvolutionTable).
  - If no pre-evo and no evolution: length 1.
  - If exactly one direction exists and the next stage does not evolve further: length 2.
  - If there is a pre-evo that has a pre-evo, or the species evolves into something that also evolves: length 3.
Use `EVOS_PER_MON`, `NUM_SPECIES`, and `gEvolutionTable` only; do not add new data tables.
  </action>
  <verify>rg "Quiz_GetEvolutionStage|Quiz_GetEvolutionLineLength" pokefirered/src/quiz/trainer_scaling.c</verify>
  <done>Evolution stage and line length helpers derive results purely from `gEvolutionTable` scans.</done>
</task>

</tasks>

<verification>
Helper module exists, builds without new dependencies, and exposes trainer/legendary/evolution utilities for quiz integration.
</verification>

<success_criteria>
- `quiz/trainer_scaling.c` compiles with no missing includes.
- Helper APIs are ready to be used by `quiz.c` for question scaling.
</success_criteria>

<output>
After completion, create `.planning/phases/12-scalable-battle-system-(stretch)/12-01-SUMMARY.md`
</output>
