---
phase: 05-capture-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pokefirered/include/quiz/quiz.h
  - pokefirered/src/quiz/quiz.c
  - pokefirered/src/quiz/quiz_hooks.c
autonomous: true
must_haves:
  truths:
    - CAPTURE_PENDING species triggers sequential capture quiz
    - Perfect run adds Pokémon to party and marks CLEARED
    - Any wrong answer ends battle with flee, state stays CAPTURE_PENDING
    - Player knows they're in "capture mode" vs "learning mode"
  artifacts:
    - Quiz_InitCaptureQuiz function for capture mode initialization
    - Quiz_AdvanceCaptureQuestion function for sequencing
    - Capture progress tracking in QuizState
    - Party add logic on perfect run
  key_links:
    - Quiz_InitWildEncounter detects CAPTURE_PENDING → calls InitCaptureQuiz
    - Quiz_OnMoveConfirmed handles capture mode differently (sequence vs mastery)
    - QuizHooks handles flee on wrong answer in capture mode
---

<objective>
Implement capture quiz state machine: when a species reaches CAPTURE_PENDING, the next encounter triggers a capture quiz where the player must answer ALL questions correctly in sequence to add the Pokémon to their party. Any wrong answer causes the Pokémon to flee.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-loop/04-01-SUMMARY.md
@pokefirered/src/quiz/quiz.c
@pokefirered/include/quiz/quiz.h
</context>

<tasks>
<task type="auto">
  <name>Add capture mode state tracking</name>
  <files>pokefirered/include/quiz/quiz.h, pokefirered/src/quiz/quiz.c</files>
  <action>
  1. Add to QuizState struct:
     - bool8 captureMode (true during capture quiz)
     - u8 captureProgress (0-based index of current question in sequence)
     - u8 captureTotal (total questions to answer for capture)
  
  2. Add Quiz_IsCaptureMode() function to quiz.h and quiz.c:
     - Returns sQuizState.captureMode
  
  3. Add Quiz_GetCaptureProgress() function:
     - Returns current progress / total (for UI, e.g., "2/5")
  </action>
  <verify>Code compiles with new struct fields and functions</verify>
  <done>QuizState has capture mode tracking, accessor functions exist</done>
</task>

<task type="auto">
  <name>Implement capture quiz initialization</name>
  <files>pokefirered/src/quiz/quiz.c</files>
  <action>
  1. Create static Quiz_InitCaptureQuiz(u16 species, const struct QuizBank *bank):
     - Set captureMode = TRUE
     - Set captureProgress = 0
     - Set captureTotal = bank->count
     - Set currentQuestion = bank->questions[0]
     - Set currentQuestionIndex = 0
     - Set active = TRUE
  
  2. Update Quiz_InitWildEncounter:
     - When state == QUIZ_STATE_CAPTURE_PENDING:
       - Call Quiz_InitCaptureQuiz instead of returning early
       - Log transition from placeholder to real capture flow
  </action>
  <verify>CAPTURE_PENDING species triggers capture quiz with first question</verify>
  <done>Capture quiz initializes correctly when CAPTURE_PENDING detected</done>
</task>

<task type="auto">
  <name>Implement capture quiz progression and completion</name>
  <files>pokefirered/src/quiz/quiz.c, pokefirered/include/quiz/quiz.h</files>
  <action>
  1. Add Quiz_AdvanceCaptureQuestion():
     - Increment captureProgress
     - If captureProgress >= captureTotal: return TRUE (complete)
     - Else: set currentQuestion to next in sequence, return FALSE
  
  2. Update Quiz_OnMoveConfirmed for capture mode:
     - On CORRECT in capture mode:
       - If Quiz_AdvanceCaptureQuestion returns TRUE (all done):
         - Set turnResult = QUIZ_TURN_CAPTURE_SUCCESS (new enum value)
         - Call Quiz_SetSpeciesState(species, QUIZ_STATE_CLEARED)
       - Else:
         - Set turnResult = QUIZ_TURN_CORRECT (continue to next question)
     - On WRONG in capture mode:
       - Set turnResult = QUIZ_TURN_CAPTURE_FAIL (new enum value)
       - (state stays CAPTURE_PENDING - automatic, we don't change it)
  
  3. Add new enum values to QuizTurnResult in quiz.h:
     - QUIZ_TURN_CAPTURE_SUCCESS
     - QUIZ_TURN_CAPTURE_FAIL
  </action>
  <verify>Capture quiz advances through questions, detects completion/failure</verify>
  <done>Perfect capture run completes, wrong answer fails, state updates correctly</done>
</task>

<task type="auto">
  <name>Implement battle outcome hooks for capture mode</name>
  <files>pokefirered/src/quiz/quiz_hooks.c</files>
  <action>
  1. Update QuizHooks_ApplyDamageOverride:
     - QUIZ_TURN_CAPTURE_SUCCESS: Set damage = 1000 (instant KO, triggers party add)
     - QUIZ_TURN_CAPTURE_FAIL: Set damage = 0 and flag for flee
     - QUIZ_TURN_CORRECT in capture mode: Set damage = 0 (no damage, continue quiz)
  
  2. Add QuizHooks_ShouldForceFlee():
     - Returns TRUE if Quiz_GetTurnResult() == QUIZ_TURN_CAPTURE_FAIL
     - This will be checked in battle controller to trigger flee
  
  3. Add to quiz_hooks.h:
     - bool8 QuizHooks_ShouldForceFlee(void);
  </action>
  <verify>Capture success KOs foe, capture fail triggers flee</verify>
  <done>Battle outcomes correctly handle capture success/fail</done>
</task>

<task type="auto">
  <name>Add Pokémon to party on capture success</name>
  <files>pokefirered/src/quiz/quiz.c, pokefirered/src/quiz/quiz_hooks.c</files>
  <action>
  1. Create Quiz_AddCapturedPokemon(u16 species) in quiz.c:
     - Use SetMonData or CreateMon to create a new Pokémon
     - Add to party using GiveMonToPlayer or AddMonToParty
     - If party full, send to PC
     - Use gEnemyParty[0] as source for level, IVs, etc.
  
  2. Integrate with battle end:
     - When QUIZ_TURN_CAPTURE_SUCCESS is detected after battle resolution,
       call Quiz_AddCapturedPokemon before the foe faints message
     - This may require a hook in the battle script or battle end routine
  
  3. Add declaration to quiz.h:
     - void Quiz_AddCapturedPokemon(u16 species);
  </action>
  <verify>After perfect capture quiz, Pokémon appears in party (or PC if full)</verify>
  <done>Captured Pokémon added to player's team</done>
</task>

<task type="checkpoint:human-verify">
  <name>Manual test capture flow</name>
  <files>N/A</files>
  <action>
  User tests in-game:
  1. Encounter species in CAPTURE_PENDING state
  2. Verify capture quiz shows all questions in sequence
  3. Answer all correctly → Pokémon added to party, species CLEARED
  4. On new encounter with same species, verify no encounter (cleared)
  5. Test failure: answer wrong → flee, species stays CAPTURE_PENDING
  6. Re-encounter → capture quiz again
  </action>
  <verify>Full capture flow works end-to-end</verify>
  <done>Player confirmed capture loop is satisfying</done>
</task>
</tasks>

<verification>
1. `make pokefirered` compiles without errors
2. Species in CAPTURE_PENDING triggers capture quiz
3. Perfect run adds Pokémon to party
4. Wrong answer during capture → flee
5. CLEARED state prevents future quiz encounters (Phase 6 filter)
</verification>

<success_criteria>
- CAPT-01: CAPTURE_PENDING species triggers capture quiz on next encounter ✓
- CAPT-02: Perfect capture quiz = Pokémon added to party/PC, state → CLEARED ✓
- CAPT-03: Failed capture quiz = Pokémon flees, state remains CAPTURE_PENDING ✓
</success_criteria>
